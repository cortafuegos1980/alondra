<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Reserva Entradas</title>
ย ยย
ย ย <style>
ย ย ย ย /* ... (Estilos CSS sin cambios) ... */
ย ย </style>
</head>
<body>
ย ยย
ย ย <div class="container">
ย ย ย ย <h2 id="tituloObra">Cargando Obra...</h2>

ย ย ย ย <div id="contenedor-superior">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="precioUnitario" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <span style="font-size:0.9em; display:block;">VALOR</span>ย
ย ย ย ย ย ย ย ย <span class="precio-monto">Cargando...</span>
ย ย ย ย ย ย </div>ย
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="caja-cupo" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <div id="cupoDiv" class="info-estado">Cargando cupo...</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="caja-tiempo" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <div id="timerDiv" class="info-estado">โฑ๏ธ 05:00</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <div id="message" class="message"></div>
ย ย ย ยย
ย ย ย ย <div id="loadingScreen">
ย ย ย ย ย ย โ Conectando con el servidor de eventos...
ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <form id="formReserva" style="display: none;">
ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="nombre">Apellido y Nombre:</label>
ย ย ย ย ย ย ย ย <input type="text" id="nombre" placeholder="Ej: Marรญa Gonzรกlez" required>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="telefono">Tu WhatsApp (Sin 0 ni 15):</label>
ย ย ย ย ย ย ย ย <input type="tel" id="telefono" placeholder="Ej: 3415123456" onkeypress="return isNumberKey(event)" required>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="cantidad">Cantidad:</label>
ย ย ย ย ย ย ย ย <input type="number" id="cantidad" min="1" max="10" value="1" required>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="fecha">Fecha del Evento:</label>
ย ย ย ย ย ย ย ย <select id="fecha" required>
ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group honeypot">
ย ย ย ย ย ย ย ย <label for="apellidoBot">No llenar este campo:</label>
ย ย ย ย ย ย ย ย <input type="text" id="apellidoBot" name="apellidoBot">
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <button type="submit" id="btnReservar">Reservar</button>
ย ย ย ย </form>
ย ย </div>
ย ยย
ย ย <script>
ย ย ย ย // *** 1. CONFIGURACIรN CRUCIAL ***
ย ย ย ย // ๐ REEMPLAZA ESTA URL CON LA QUE TE DIO EL NUEVO DESPLIEGUE PรBLICO
ย ย ย ย const EXEC_URL = 'https://script.google.com/macros/s/AKfycbxouqas6Wvyf5gWWtPjHnUSfMcqgr__uBYah00v1tVhsqDAVgTR_dRZ5r5bBG_Fjm7e/exec';ย
ย ย ย ย const OBRA_FILTRO_NOMBRE = 'La Jirafa';ย
ย ย ย ย const MANAGER_WHATSAPP_NUMBER = '5493492594940';ย

ย ย ย ย let timerTimeout;ย
ย ย ย ย let todosLosCupos = {};ย

ย ย ย ย // ๐ CACHING DE ELEMENTOS DEL DOM
ย ย ย ย const DOM_ELEMENTS = {
ย ย ย ย ย ย // ... (resto de elementos sin cambios) ...
ย ย ย ย ย ย tituloObra: document.getElementById('tituloObra'),
ย ย ย ย ย ย message: document.getElementById('message'),
ย ย ย ย ย ย btnReservar: document.getElementById('btnReservar'),
ย ย ย ย ย ย fecha: document.getElementById('fecha'),
ย ย ย ย ย ย cupoDiv: document.getElementById('cupoDiv'),
ย ย ย ย ย ย precioDiv: document.getElementById('precioUnitario'),
ย ย ย ย ย ย timerDiv: document.getElementById('timerDiv'),
ย ย ย ย ย ย formReserva: document.getElementById('formReserva'),ย
ย ย ย ย ย ย loadingScreen: document.getElementById('loadingScreen'),
ย ย ย ย ย ย // Campos del formulario
ย ย ย ย ย ย nombre: document.getElementById('nombre'),
ย ย ย ย ย ย telefono: document.getElementById('telefono'),
ย ย ย ย ย ย cantidad: document.getElementById('cantidad'),
ย ย ย ย ย ย apellidoBot: document.getElementById('apellidoBot')
ย ย ย ย };

ย ย ย ย // ... (El resto de las funciones JavaScript no necesitan cambios) ...
ย ย ย ย 
ย ย ย ย // -------------------------------------------------------------------------
ย ย ย ย // VALIDACIรN ESTRICTA DE WHATSAPP (Solo nรบmeros)
ย ย ย ย // -------------------------------------------------------------------------
ย ย ย ย function isNumberKey(evt) {
ย ย ย ย ย ย const charCode = (evt.which) ? evt.which : event.keyCode;
ย ย ย ย ย ย return !(charCode > 31 && (charCode < 48 || charCode > 57));
ย ย ย ย }


ย ย ย ย /* Funciรณn para mostrar mensajes de estado */
ย ย ย ย function mostrarMensaje(texto, tipo = 'error') {
ย ย ย ย ย ย const messageDiv = DOM_ELEMENTS.message;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!texto) {
ย ย ย ย ย ย ย ย messageDiv.style.display = 'none';
ย ย ย ย ย ย ย ย messageDiv.className = 'message';ย
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย messageDiv.textContent = texto;
ย ย ย ย ย ย messageDiv.style.display = 'block';
ย ย ย ย ย ย messageDiv.className = 'message';ย
ย ย ย ย ย ย messageDiv.style.textTransform = 'none';ย

ย ย ย ย ย ย if (tipo === 'exito') {
ย ย ย ย ย ย ย ย messageDiv.classList.add('message-success');
ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย messageDiv.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย messageDiv.className = 'message';
ย ย ย ย ย ย ย ย }, 8000);ย
ย ย ย ย ย ย } else if (tipo === 'error') {
ย ย ย ย ย ย ย ย messageDiv.classList.add('message-error');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /* CARGAR NOMBRE DE OBRA */
ย ย ย ย async function cargarNombreObra() {
ย ย ย ย ย ย const tituloObra = DOM_ELEMENTS.tituloObra;
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const url = EXEC_URL + '?accion=obtenerNombre&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE);
ย ย ย ย ย ย ย ย const response = await fetch(url);ย
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (!response.ok) {ย
ย ย ย ย ย ย ย ย ย ย throw new Error(`Error HTTP: ${response.status}`);ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (data.status === 'OK' && data.nombre) {
ย ย ย ย ย ย ย ย ย ย const nuevoNombre = 'Reserva Entradas - ' + data.nombre;
ย ย ย ย ย ย ย ย ย ย document.title = nuevoNombre;
ย ย ย ย ย ย ย ย ย ย tituloObra.textContent = nuevoNombre;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย document.title = 'Reserva de Entradas';
ย ย ย ย ย ย ย ย ย ย tituloObra.textContent = 'Reserva de Entradas';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย ย ย console.error('Error FATAL al cargar nombre de obra:', err);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ยย
ย ย ย ย /* TEMPORIZADOR (Columna 3) */
ย ย ย ย function startTimer() {
ย ย ย ย ย ย let duration = 5 * 60;ย
ย ย ย ย ย ย const { timerDiv, btnReservar } = DOM_ELEMENTS;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (btnReservar) {
ย ย ย ย ย ย ย ย btnReservar.disabled = false;
ย ย ย ย ย ย ย ย btnReservar.classList.remove('loading');
ย ย ย ย ย ย }

ย ย ย ย ย ย if (timerTimeout) clearInterval(timerTimeout);ย

ย ย ย ย ย ย function updateTimer() {
ย ย ย ย ย ย ย ย const minutes = parseInt(duration / 60, 10);
ย ย ย ย ย ย ย ย const seconds = parseInt(duration % 60, 10);

ย ย ย ย ย ย ย ย const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
ย ย ย ย ย ย ย ย const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

ย ย ย ย ย ย ย ย timerDiv.textContent = "โฑ๏ธ " + displayMinutes + ":" + displaySeconds;ย

ย ย ย ย ย ย ย ย if (--duration < 0) {
ย ย ย ย ย ย ย ย ย ย clearInterval(timerTimeout);ย
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย if (btnReservar) {
ย ย ย ย ย ย ย ย ย ย ย ย btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย timerDiv.textContent = "โฑ๏ธ 00:00";
ย ย ย ย ย ย ย ย ย ย mostrarMensaje('โฐ Tiempo agotado. Debes actualizar la pรกgina para iniciar una nueva reserva.', 'error');ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย updateTimer();ย
ย ย ย ย ย ย timerTimeout = setInterval(updateTimer, 1000);
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* CARGAR OPCIONES DEL EVENTO */
ย ย ย ย async function cargarOpcionesEventos(opciones) {
ย ย ย ย ย ย const { fecha: select, cupoDiv, loadingScreen, formReserva } = DOM_ELEMENTS;
ย ย ย ย ย ย select.innerHTML = '';
ย ย ย ย ย ยย
ย ย ย ย ย ย // ๐ OCULTAR PANTALLA DE CARGA Y MOSTRAR FORMULARIO
ย ย ย ย ย ย loadingScreen.style.display = 'none';ย
ย ย ย ย ย ย formReserva.style.display = 'block';ย

ย ย ย ย ย ย if (opciones.length === 0) {
ย ย ย ย ย ย ย ย const opt = document.createElement('option');
ย ย ย ย ย ย ย ย opt.textContent = "No hay eventos disponibles";
ย ย ย ย ย ย ย ย select.appendChild(opt);
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'No hay eventos configurados.';
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย opciones.forEach(opcion => {
ย ย ย ย ย ย ย ย const opt = document.createElement('option');
ย ย ย ย ย ย ย ย opt.value = opcion.id;
ย ย ย ย ย ย ย ย opt.textContent = opcion.texto;ย
ย ย ย ย ย ย ย ย select.appendChild(opt);
ย ย ย ย ย ย });

ย ย ย ย ย ย await actualizarCupo();ย
ย ย ย ย ย ย mostrarCupoSeleccionado();
ย ย ย ย }


ย ย ย ย /* ACTUALIZAR CUPO (Llamada al servidor) */
ย ย ย ย async function actualizarCupo() {
ย ย ย ย ย ย const cupoDiv = DOM_ELEMENTS.cupoDiv;
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(EXEC_URL + '?accion=consultarCupo');ย
ย ย ย ย ย ย ย ย const data = await response.json();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (data.status === 'OK' && data.cupos) {
ย ย ย ย ย ย ย ย ย ย todosLosCupos = data.cupos;ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Error al verificar cupo.';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย ย ย console.error('Error al consultar cupo:', err);
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Error de conexiรณn.';
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย /* MOSTRAR CUPO Y PRECIO SELECCIONADO */
ย ย ย ย async function mostrarCupoSeleccionado() {ย
ย ย ย ย ย ย const { fecha: selectFecha, cupoDiv, precioDiv, btnReservar, timerDiv } = DOM_ELEMENTS;
ย ย ย ย ย ย const idSeleccionado = selectFecha.value;
ย ย ย ย ย ยย
ย ย ย ย ย ยย
ย ย ย ย ย ย if (timerDiv.textContent.includes('00:00')) {
ย ย ย ย ย ย ย ย if (btnReservar) btnReservar.disabled = true;
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!idSeleccionado || idSeleccionado === "") {
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Selecciona una funciรณn.';
ย ย ย ย ย ย ย ย precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
ย ย ย ย ย ย ย ย if (btnReservar) btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }


ย ย ย ย ย ย if (todosLosCupos.hasOwnProperty(idSeleccionado)) {
ย ย ย ย ย ย ย ย const cupoRestante = todosLosCupos[idSeleccionado];

ย ย ย ย ย ย ย ย if (cupoRestante === 0) {
ย ย ย ย ย ย ย ย ย ย cupoDiv.textContent = '๐๏ธ AGOTADO';
ย ย ย ย ย ย ย ย ย ย cupoDiv.classList.add('agotado-rojo');
ย ย ย ย ย ย ย ย ย ย if (btnReservar) btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย cupoDiv.textContent = `๐๏ธ ${cupoRestante} disp.`;
ย ย ย ย ย ย ย ย ย ย cupoDiv.classList.remove('agotado-rojo');
ย ย ย ย ย ย ย ย ย ย if (btnReservar) btnReservar.disabled = false;ย
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย const opciones = selectFecha.options;
ย ย ย ย ย ย ย ย for (let opt of opciones) {
ย ย ย ย ย ย ย ย ย ย if(todosLosCupos.hasOwnProperty(opt.value)) {
ย ย ย ย ย ย ย ย ย ย ย ย const cupo = todosLosCupos[opt.value];
ย ย ย ย ย ย ย ย ย ย ย ย let textoLimpio = opt.textContent.replace(' (Agotado)', '').trim();

ย ย ย ย ย ย ย ย ย ย ย ย if (cupo === 0) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.textContent = textoLimpio + " (Agotado)";
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.style.color = "#b5b5b5";ย
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.textContent = textoLimpio;ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.style.color = "black";
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 4. ACTUALIZAR PRECIO (Llamada al servidor)
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
ย ย ย ย ย ย ย ย ย ย const url = EXEC_URL + '?accion=obtenerPrecio&idEvento=' + encodeURIComponent(idSeleccionado);
ย ย ย ย ย ย ย ย ย ย const response = await fetch(url);
ย ย ย ย ย ย ย ย ย ย const data = await response.json();

ย ย ย ย ย ย ย ย ย ย if (data.status === 'OK' && data.precio) {
ย ย ย ย ย ย ย ย ย ย ย ย precioDiv.innerHTML = `
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.9em; display:block;">VALOR</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="precio-monto">$${data.precio}</span>
ย ย ย ย ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">N/A</span>';
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } catch (error) {
ย ย ย ย ย ย ย ย ย ย console.error('Error al actualizar precio:', error);
ย ย ย ย ย ย ย ย ย ย precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">Error</span>';
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Selecciona una funciรณn.';
ย ย ย ย ย ย ย ย precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
ย ย ย ย ย ย ย ย if (btnReservar) btnReservar.disabled = true;ย
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย // *** LรGICA DE ENVรO Y MANEJO DE EVENTOS ***
ย ย ย ยย
ย ย ย ย DOM_ELEMENTS.formReserva.addEventListener('submit', async function(event) {
ย ย ย ย ย ย event.preventDefault();ย
ย ย ย ย ย ยย
ย ย ย ย ย ย mostrarMensaje('');ย

ย ย ย ย ย ย // Desestructuraciรณn para usar nombres mรกs cortos en la funciรณn
ย ย ย ย ย ย const { btnReservar: btn, nombre, telefono, cantidad, fecha, apellidoBot } = DOM_ELEMENTS;

ย ย ย ย ย ย const nombreVal = nombre.value.trim();
ย ย ย ย ย ย const telefonoCliente = telefono.value.trim().replace(/\D/g,'');ย
ย ย ย ย ย ย const cantidadVal = parseInt(cantidad.value);
ย ย ย ย ย ย const fechaVal = fecha.value;ย

ย ย ย ย ย ย // ** VALIDACIONES FINALES **
ย ย ย ย ย ย if (!nombreVal || !telefonoCliente || !cantidadVal || !fechaVal) {
ย ย ย ย ย ย ย ย mostrarMensaje('๐ก Completa todos los campos.', 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย if (btn.disabled) {
ย ย ย ย ย ย ย ย mostrarMensaje('โฐ Tiempo de reserva agotado o evento sin cupo. Actualiza la pรกgina para comenzar de nuevo.', 'error');
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย // VALIDACIรN HONEYPOT (ANTI-SPAM)
ย ย ย ย ย ย if (apellidoBot.value.trim().length > 0) {
ย ย ย ย ย ย ย ย mostrarMensaje('โ Error de validaciรณn de formulario.', 'error');
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย // Verifica que haya cupo (doble chequeo)
ย ย ย ย ย ย const cupoActual = todosLosCupos[fechaVal] || 0;
ย ย ย ย ย ย if (cantidadVal > cupoActual) {
ย ย ย ย ย ย ย ย mostrarMensaje(`Solo quedan ${cupoActual} entradas. Ajusta la cantidad.`, 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย // ** FIN VALIDACIONES **

ย ย ย ย ย ย const formData = new URLSearchParams();
ย ย ย ย ย ย formData.append('accion', 'reservar');
ย ย ย ย ย ย formData.append('nombre', nombreVal);
ย ย ย ย ย ย formData.append('telefono', telefonoCliente);
ย ย ย ย ย ย formData.append('cantidad', cantidadVal);
ย ย ย ย ย ย formData.append('fecha', fechaVal);ย

ย ย ย ย ย ย // Desactivamos y mostramos carga ANTES de la llamada
ย ย ย ย ย ย btn.disabled = true;
ย ย ย ย ย ย btn.classList.add('loading');
ย ย ย ย ย ย clearInterval(timerTimeout); // Detenemos el contador


ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(EXEC_URL, { method: 'POST', body: formData });ย
ย ย ย ย ย ย ย ย const data = await response.json();

ย ย ย ย ย ย ย ย if (data.status === 'OK') {
ย ย ย ย ย ย ย ย ย ย mostrarMensaje(`โ ยกRESERVA EXITOSA! ID: ${data.id}. Total: $${data.montoTotal}. Redirigiendo a WhatsApp...`, 'exito');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const mensajeWhatsApp = [
ย ย ย ย ย ย ย ย ย ย ย ย `ยกHola! Mi reserva es la ID: *${data.id}*.`,
ย ย ย ย ย ย ย ย ย ย ย ย `Confirmo la reserva de *${cantidadVal}* entradas.`,
ย ย ย ย ย ย ย ย ย ย ย ย `Mi telรฉfono (Cliente) es: *${telefonoCliente}*`,ย
ย ย ย ย ย ย ย ย ย ย ย ย `El monto total es de *$${data.montoTotal}*.`,
ย ย ย ย ย ย ย ย ย ย ย ย ``,
ย ย ย ย ย ย ย ย ย ย ย ย `โญ *LINK DE PAGO MERCADO PAGO:*`,
ย ย ย ย ย ย ย ย ย ย ย ย `${data.linkPago}`,ย
ย ย ย ย ย ย ย ย ย ย ย ย ``,
ย ย ย ย ย ย ย ย ย ย ย ย `*IMPORTANTE:* Si el pago no se realiza en 5 minutos, la reserva puede cancelarse.`
ย ย ย ย ย ย ย ย ย ย ].join('\n');ย

ย ย ย ย ย ย ย ย ย ย const mensajeURL = encodeURIComponent(mensajeWhatsApp);
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย window.open(`https://wa.me/${MANAGER_WHATSAPP_NUMBER}?text=${mensajeURL}`, '_blank');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย actualizarCupo().then(() => mostrarCupoSeleccionado());
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย btn.disabled = true;ย
ย ย ย ย ย ย ย ย ย ย btn.classList.remove('loading');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย mostrarMensaje('โ ' + data.message, 'error');
ย ย ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย ย ย btn.classList.remove('loading');
ย ย ย ย ย ย ย ย ย ย startTimer();ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย ย ย mostrarMensaje('โ Error de conexiรณn o red: ' + err.message, 'error');
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย btn.classList.remove('loading');
ย ย ย ย ย ย ย ย startTimer();ย
ย ย ย ย ย ย }
ย ย ย ย });


ย ย ย ย DOM_ELEMENTS.fecha.addEventListener('change', mostrarCupoSeleccionado);


ย ย ย ย // *** 4. INICIAR LAS FUNCIONES AL CARGAR (Solo una vez) ***
ย ย ย ย cargarNombreObra();ย
ย ย ย ย startTimer();ย
ย ย ย ย // ๐ MIENTRAS SE CARGAN LOS EVENTOS, MOSTRAMOS LA PANTALLA DE CARGA
ย ย ย ย DOM_ELEMENTS.loadingScreen.style.display = 'block';ย
ย ย ย ย DOM_ELEMENTS.formReserva.style.display = 'none';ย
ย ย ย ยย
ย ย ย ย fetch(EXEC_URL + '?accion=obtenerOpciones&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE))
ย ย ย ย ย ย .then(response => response.json())
ย ย ย ย ย ย .then(data => cargarOpcionesEventos(data))
ย ย ย ย ย ย .catch(err => {
ย ย ย ย ย ย ย ย console.error('Error FATAL al cargar eventos (EXEC_URL incorrecta?):', err);
ย ย ย ย ย ย ย ย DOM_ELEMENTS.loadingScreen.textContent = 'โ Error crรญtico al cargar eventos. Verifique la URL de Apps Script.';
ย ย ย ย ย ย });
ย ย </script>
</body>
</html>
