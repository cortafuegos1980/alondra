<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>Reserva Entradas</title>
ย ยย
ย ย <style>
ย ย ย ย /* Estilos Globales */
ย ย ย ย body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
ย ย ย ย .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
ย ย ย ย .form-group { margin-bottom: 20px; }
ย ย ย ย label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
ย ย ย ยย
ย ย ย ย /* Estilo de validaciรณn */
ย ย ย ย input:invalid:not(:focus), select:invalid:not(:focus) {ย
ย ย ย ย ย ย border: 2px solid #D32F2F; /* Rojo de error */
ย ย ย ย }
ย ย ย ย input, select {ย
ย ย ย ย ย ย width: 100%;ย
ย ย ย ย ย ย padding: 12px;ย
ย ย ย ย ย ย border: 1px solid #ccc;ย
ย ย ย ย ย ย border-radius: 5px;ย
ย ย ย ย ย ย box-sizing: border-box;ย
ย ย ย ย ย ย transition: border-color 0.2s;
ย ย ย ย }
ย ย ย ย input:focus, select:focus {
ย ย ย ย ย ย border-color: #25D366;
ย ย ย ย ย ย outline: none;
ย ย ย ย }

ย ย ย ย /* Anti-spam */
ย ย ย ย .honeypot { display: none; visibility: hidden; height: 0; width: 0; position: absolute; left: -9999px; }

ย ย ย ย /* --- ESTILOS SUPERIORES (3 COLUMNAS) --- */
ย ย ย ย #contenedor-superior {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: space-between;
ย ย ย ย ย ย flex-wrap: wrap;ย
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย ย ย gap: 5px; /* Separaciรณn mรกs limpia */
ย ย ย ย }

ย ย ย ย /* Estilo general de las 3 cajas */
ย ย ย ย .caja-estado-superior {
ย ย ย ย ย ย padding: 8px 10px; /* Mรกs padding */
ย ย ย ย ย ย border: 1px solid #e0e0e0;
ย ย ย ย ย ย border-radius: 6px;
ย ย ย ย ย ย background-color: #fcfcfc;ย
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย flex-grow: 1;ย
ย ย ย ย ย ย flex-basis: calc(33.33% - 10px); /* Asegurar que sean 3 columnas */
ย ย ย ย ย ย font-size: 0.9em;
ย ย ย ย ย ย font-weight: 500;
ย ย ย ย }
        /* Ajuste para la caja central del cupo */
        #caja-cupo {
            flex-basis: calc(33.33% - 10px);
        }

ย ย ย ย .precio-label { font-size: 0.9em; display:block; color: #666; }
ย ย ย ย .precio-monto {
ย ย ย ย ย ย font-size: 1.3em;ย
ย ย ย ย ย ย color: #000;ย
ย ย ย ย ย ย display: block;
ย ย ย ย ย ย margin-top: 2px;ย
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }

ย ย ย ย .agotado-rojo {
ย ย ย ย ย ย color: #D32F2F;ย
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย }

ย ย ย ย /* --- ESTILOS DEL BOTรN RESERVAR --- */
ย ย ย ย #btnReservar {ย
ย ย ย ย ย ย width: 100%;ย
ย ย ย ย ย ย padding: 15px;ย
ย ย ย ย ย ย background: #25D366;ย
ย ย ย ย ย ย color: white;ย
ย ย ย ย ย ย border: none;ย
ย ย ย ย ย ย border-radius: 5px;ย
ย ย ย ย ย ย font-size: 16px;ย
ย ย ย ย ย ย font-weight: bold;ย
ย ย ย ย ย ย cursor: pointer;ย
ย ย ย ย ย ย transition: background 0.3s, opacity 0.3s;ย
ย ย ย ย ย ย margin-top: 10px;ย
ย ย ย ย }
ย ย ย ยย
ย ย ย ย #btnReservar:hover:not(:disabled) {
ย ย ย ย ย ย background: #1da851;
ย ย ย ย }

ย ย ย ย #btnReservar:disabled, #btnReservar.loading {
ย ย ย ย ย ย background: #cccccc;ย
ย ย ย ย ย ย color: #666666;ย
ย ย ย ย ย ย cursor: not-allowed;ย
ย ย ย ย ย ย opacity: 0.8;ย
ย ย ย ย ย ย box-shadow: none;
ย ย ย ย }

ย ย ย ย /* --- ESTILOS DEL MENSAJE DE ESTADO --- */
ย ย ย ย .message {ย
ย ย ย ย ย ย padding: 15px;ย
ย ย ย ย ย ย border-radius: 8px;ย
ย ย ย ย ย ย margin: 15px 0 20px 0; /* Ajuste de margen */
ย ย ย ย ย ย display: none;ย
ย ย ย ย ย ย text-align: center;ย
ย ย ย ย ย ย font-size: 1.0em;
ย ย ย ย ย ย line-height: 1.4;
ย ย ย ย }

ย ย ย ย /* Clase para errores */
ย ย ย ย .message-error {
ย ย ย ย ย ย background-color: #f8d7da;ย
ย ย ย ย ย ย color: #721c24;ย
ย ย ย ย ย ย border: 1px solid #f5c6cb;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย }

ย ย ย ย /* Clase para รฉxito */
ย ย ย ย .message-success {
ย ย ย ย ย ย background-color: #d4edda;ย
ย ย ย ย ย ย color: #155724;ย
ย ย ย ย ย ย border: 1px solid #c3e6cb;
ย ย ย ย }
ย ย </style>
</head>
<body>
ย ยย
ย ย <div class="container">
ย ย ย ย <h2 id="tituloObra">Cargando Obra...</h2>

ย ย ย ย <div id="contenedor-superior">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="precioUnitario" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <span class="precio-label">VALOR</span>ย
ย ย ย ย ย ย ย ย <span class="precio-monto">Cargando...</span>
ย ย ย ย ย ย </div>ย
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="caja-cupo" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <div id="cupoDiv" class="info-estado">Cargando cupo...</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="caja-tiempo" class="caja-estado-superior">
ย ย ย ย ย ย ย ย <div id="timerDiv" class="info-estado">โฑ๏ธ 05:00</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <div id="message" class="message"></div>
ย ย ย ยย
ย ย ย ย <form id="formReserva">
ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="nombre">Apellido y Nombre:</label>
ย ย ย ย ย ย ย ย <input type="text" id="nombre" placeholder="Ej: Marรญa Gonzรกlez" required>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="telefono">Tu WhatsApp (Sin 0 ni 15):</label>
ย ย ย ย ย ย ย ย <inputย
ย ย ย ย ย ย ย ย ย ย type="tel"ย
ย ย ย ย ย ย ย ย ย ย id="telefono"ย
ย ย ย ย ย ย ย ย ย ย placeholder="Ej: 3415123456"ย
ย ย ย ย ย ย ย ย ย ย onkeypress="return isNumberKey(event)"ย
ย ย ย ย ย ย ย ย ย ย required
ย ย ย ย ย ย ย ย ย ย minlength="8"ย
ย ย ย ย ย ย ย ย ย ย maxlength="15"ย
ย ย ย ย ย ย ย ย ย ย pattern="[0-9]{8,15}"ย
ย ย ย ย ย ย ย ย ย ย title="Ingresa entre 8 y 15 dรญgitos numรฉricos, solo el nรบmero de celular."
ย ย ย ย ย ย ย ย ย ย data-min-length="8"
ย ย ย ย ย ย ย ย ย ย data-max-length="15"
ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="cantidad">Cantidad:</label>
ย ย ย ย ย ย ย ย <input type="number" id="cantidad" min="1" max="10" value="1" required>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group">
ย ย ย ย ย ย ย ย <label for="fecha">Fecha del Evento:</label>
ย ย ย ย ย ย ย ย <select id="fecha" required>
ย ย ย ย ย ย ย ย ย ย <option value="" disabled selected>Cargando opciones...</option>
ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="form-group honeypot">
ย ย ย ย ย ย ย ย <label for="apellidoBot">No llenar este campo (Anti-Spam):</label>
ย ย ย ย ย ย ย ย <input type="text" id="apellidoBot" name="apellidoBot">
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <button type="submit" id="btnReservar">Reservar</button>
ย ย ย ย </form>
ย ย </div>
ย ยย
ย ย <script>
ย ย ย ย // *** 1. CONFIGURACIรN CRUCIAL - ยกDEBES CAMBIAR ESTA URL! ***
ย ย ย ย // ๐ REEMPLAZA esta URL de ejemplo por la URL de tu Implementaciรณn Web Final.
ย ย ย ย const EXEC_URL = 'https://script.google.com/macros/s/AKfycbx7IqI9ZJ3SY2SHB-mf8Ykqw0TeX2BTy5TVEzuNkDbXuald7ohpIva3Vv5oaLSrpD6y/exec';ย
ย ย ย ยย
ย ย ย ย const OBRA_FILTRO_NOMBRE = 'La Jirafa';ย
ย ย ย ย const MANAGER_WHATSAPP_NUMBER = '5493492594940';ย

ย ย ย ย let timerTimeout;ย
ย ย ย ย let todosLosCupos = {};ย

ย ย ย ย // ๐ OPTIMIZACIรN DEL DOM: Guardamos las referencias una sola vez
ย ย ย ย const DOM_ELEMENTS = {
ย ย ย ย ย ย tituloObra: document.getElementById('tituloObra'),
ย ย ย ย ย ย message: document.getElementById('message'),
ย ย ย ย ย ย btnReservar: document.getElementById('btnReservar'),
ย ย ย ย ย ย fecha: document.getElementById('fecha'),
ย ย ย ย ย ย cupoDiv: document.getElementById('cupoDiv'),
ย ย ย ย ย ย precioDiv: document.getElementById('precioUnitario').querySelector('.precio-monto'),
ย ย ย ย ย ย timerDiv: document.getElementById('timerDiv'),
ย ย ย ย ย ย formReserva: document.getElementById('formReserva'),ย
ย ย ย ย ย ย nombre: document.getElementById('nombre'),
ย ย ย ย ย ย telefono: document.getElementById('telefono'),
ย ย ย ย ย ย cantidad: document.getElementById('cantidad'),
ย ย ย ย ย ย apellidoBot: document.getElementById('apellidoBot')
ย ย ย ย };
ย ย ย ยย
ย ย ย ย const MIN_CELULAR_LENGTH = parseInt(DOM_ELEMENTS.telefono.dataset.minLength, 10) || 8;
ย ย ย ย const MAX_CELULAR_LENGTH = parseInt(DOM_ELEMENTS.telefono.dataset.maxLength, 10) || 15;


ย ย ย ย // VALIDACIรN ESTRICTA DE WHATSAPP (Solo nรบmeros)
ย ย ย ย function isNumberKey(evt) {
ย ย ย ย ย ย const charCode = (evt.which) ? evt.which : event.keyCode;
ย ย ย ย ย ย return !(charCode > 31 && (charCode < 48 || charCode > 57));
ย ย ย ย }


ย ย ย ย /* Funciรณn para mostrar mensajes de estado */
ย ย ย ย function mostrarMensaje(texto, tipo = 'error') {
ย ย ย ย ย ย const messageDiv = DOM_ELEMENTS.message;
ย ย ย ย ย ยย
ย ย ย ย ย ย messageDiv.style.display = 'none';
ย ย ย ย ย ย messageDiv.className = 'message';ย
ย ย ย ย ย ย if (!texto) return;

ย ย ย ย ย ย messageDiv.textContent = texto;
ย ย ย ย ย ย messageDiv.style.display = 'block';
ย ย ย ย ย ยย
ย ย ย ย ย ย if (tipo === 'exito') {
ย ย ย ย ย ย ย ย messageDiv.classList.add('message-success');
ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย messageDiv.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย messageDiv.className = 'message';
ย ย ย ย ย ย ย ย }, 8000);ย
ย ย ย ย ย ย } else if (tipo === 'error') {
ย ย ย ย ย ย ย ย messageDiv.classList.add('message-error');
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* Funciรณn de utilidad para peticiones GET y POST */
ย ย ย ย async function fetchData(action, params = {}, method = 'GET', body = null) {
ย ย ย ย ย ย const query = new URLSearchParams({ accion: action, ...params }).toString();
ย ย ย ย ย ย let url = `${EXEC_URL}?${query}`;
            let options = { method: method };

            if (method === 'POST' && body) {
                options.body = body;
                url = EXEC_URL; 
            }
ย ย ย ย ย ยย
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const response = await fetch(url, options);ย
                // ๐ CORRECCIรN: Manejo de errores HTTP antes de intentar parsear JSON
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Error HTTP: ${response.status} en ${action}. Respuesta: ${errorText}`);
                    // Intentamos parsear JSON solo si el Content-Type lo indica
                    if (response.headers.get('Content-Type')?.includes('application/json')) {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.message || `Error HTTP ${response.status} sin mensaje detallado.`);
                    }
ย ย ย ย ย ย ย ย ย ย throw new Error(`Error de servidor (${response.status}). Asegura que la URL de EXEC_URL es la correcta y estรก implementada.`);ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย return await response.json();
ย ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย ย ย console.error(`Error en fetchData (${action}):`, err);
ย ย ย ย ย ย ย ย return { status: 'ERROR', message: err.message };
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย /* CARGAR NOMBRE DE OBRA */
ย ย ย ย async function cargarNombreObra() {
ย ย ย ย ย ย const data = await fetchData('obtenerNombre', { obra: OBRA_FILTRO_NOMBRE });
ย ย ย ย ย ยย
ย ย ย ย ย ย if (data.status === 'OK' && data.nombre) {
ย ย ย ย ย ย ย ย const nuevoNombre = 'Reserva Entradas - ' + data.nombre;
ย ย ย ย ย ย ย ย document.title = nuevoNombre;
ย ย ย ย ย ย ย ย DOM_ELEMENTS.tituloObra.textContent = nuevoNombre;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย document.title = 'Reserva de Entradas';
ย ย ย ย ย ย ย ย DOM_ELEMENTS.tituloObra.textContent = 'Reserva de Entradas';
ย ย ย ย ย ย ย ย console.error('Error al cargar nombre de la obra. Usando predeterminado.');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ยย
ย ย ย ย /* TEMPORIZADOR */
ย ย ย ย function startTimer() {
ย ย ย ย ย ย let duration = 5 * 60;ย
ย ย ย ย ย ย const { timerDiv, btnReservar } = DOM_ELEMENTS;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (timerTimeout) clearInterval(timerTimeout);ย
ย ย ย ย ย ย 
ย ย ย ย ย ย // Habilitar botรณn al inicio del timer (si hay selecciรณn y cupo)
ย ย ย ย ย ย btnReservar.disabled = false;
ย ย ย ย ย ย btnReservar.classList.remove('loading');

ย ย ย ย ย ย function updateTimer() {
ย ย ย ย ย ย ย ย const minutes = parseInt(duration / 60, 10);
ย ย ย ย ย ย ย ย const seconds = parseInt(duration % 60, 10);

ย ย ย ย ย ย ย ย const displayMinutes = String(minutes).padStart(2, '0');
ย ย ย ย ย ย ย ย const displaySeconds = String(seconds).padStart(2, '0');

ย ย ย ย ย ย ย ย timerDiv.textContent = "โฑ๏ธ " + displayMinutes + ":" + displaySeconds;ย

ย ย ย ย ย ย ย ย if (--duration < 0) {
ย ย ย ย ย ย ย ย ย ย clearInterval(timerTimeout);ย
ย ย ย ย ย ย ย ย ย ย btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย ย ย timerDiv.textContent = "โฑ๏ธ 00:00";
ย ย ย ย ย ย ย ย ย ย mostrarMensaje('โฐ TIEMPO AGOTADO. Debes actualizar la pรกgina para iniciar una nueva reserva.', 'error');ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย updateTimer();ย
ย ย ย ย ย ย timerTimeout = setInterval(updateTimer, 1000);
ย ย ย ย }
ย ย ย ยย
ย ย ย ย /* CARGAR OPCIONES DEL EVENTO */
ย ย ย ย function cargarOpcionesEventos(opciones) {
ย ย ย ย ย ย const { fecha: select, cupoDiv, btnReservar } = DOM_ELEMENTS;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (!opciones || opciones.length === 0) {
ย ย ย ย ย ย ย ย select.innerHTML = '<option value="" disabled selected>No hay eventos disponibles</option>';
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'โ๏ธ Sin funciones.';
ย ย ย ย ย ย ย ย btnReservar.disabled = true;
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
            // Agrega la opciรณn por defecto
            let opcionesHTML = '<option value="" disabled selected>Selecciona una fecha y hora</option>';

ย ย ย ย ย ย opcionesHTML += opciones.map(opcion =>ย
ย ย ย ย ย ย ย ย `<option value="${opcion.id}">${opcion.texto}</option>`
ย ย ย ย ย ย ).join('');

ย ย ย ย ย ย select.innerHTML = opcionesHTML;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Actualizar cupo y mostrar el estado inicial
ย ย ย ย ย ย actualizarCupo().then(mostrarCupoSeleccionado);
ย ย ย ย }


ย ย ย ย /* ACTUALIZAR CUPO (Llamada al servidor) */
ย ย ย ย async function actualizarCupo() {
ย ย ย ย ย ย const data = await fetchData('consultarCupo');
ย ย ย ย ย ยย
ย ย ย ย ย ย if (data.status === 'OK' && data.cupos) {
ย ย ย ย ย ย ย ย todosLosCupos = data.cupos;ย
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย DOM_ELEMENTS.cupoDiv.textContent = 'โ Error al verificar cupo.';
ย ย ย ย ย ย ย ย console.error('Error de Cupo:', data.message);
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย /* MOSTRAR CUPO Y PRECIO SELECCIONADO */
ย ย ย ย async function mostrarCupoSeleccionado() {ย
ย ย ย ย ย ย const { fecha: selectFecha, cupoDiv, precioDiv, btnReservar, timerDiv } = DOM_ELEMENTS;
ย ย ย ย ย ย const idSeleccionado = selectFecha.value;
ย ย ย ย ย ยย
ย ย ย ย ย ย // 1. Pre-chequeo del timer
ย ย ย ย ย ย if (timerDiv.textContent.includes('00:00')) {
ย ย ย ย ย ย ย ย btnReservar.disabled = true;
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // 2. Si no hay evento seleccionado
ย ย ย ย ย ย if (!idSeleccionado || idSeleccionado === "") {
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Selecciona una funciรณn.';
ย ย ย ย ย ย ย ย precioDiv.textContent = '...';
ย ย ย ย ย ย ย ย btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
            
            // 3. Actualizar PRECIO (primero para calcular el monto)
ย ย ย ย ย ย precioDiv.textContent = 'Cargando...';
ย ย ย ย ย ย const dataPrecio = await fetchData('obtenerPrecio', { idEvento: idSeleccionado });

ย ย ย ย ย ย if (dataPrecio.status === 'OK' && dataPrecio.precio) {
ย ย ย ย ย ย ย ย precioDiv.textContent = `$${dataPrecio.precio}`;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย precioDiv.textContent = 'N/A';
ย ย ย ย ย ย ย ย console.error('Error al obtener precio:', dataPrecio.message);
ย ย ย ย ย ย }

            // 4. Actualizar Cupo
ย ย ย ย ย ย if (todosLosCupos.hasOwnProperty(idSeleccionado)) {
ย ย ย ย ย ย ย ย const cupoRestante = todosLosCupos[idSeleccionado];

ย ย ย ย ย ย ย ย // Indicador visual de Cupo
ย ย ย ย ย ย ย ย if (cupoRestante === 0) {
ย ย ย ย ย ย ย ย ย ย cupoDiv.textContent = '๐๏ธ AGOTADO';
ย ย ย ย ย ย ย ย ย ย cupoDiv.classList.add('agotado-rojo');
ย ย ย ย ย ย ย ย ย ย btnReservar.disabled = true;ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย cupoDiv.textContent = `๐๏ธ ${cupoRestante} disp.`;
ย ย ย ย ย ย ย ย ย ย cupoDiv.classList.remove('agotado-rojo');
ย ย ย ย ย ย ย ย ย ย btnReservar.disabled = false;ย
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // Actualizar texto del SELECT para mostrar "(Agotado)"
ย ย ย ย ย ย ย ย Array.from(selectFecha.options).forEach(opt => {
ย ย ย ย ย ย ย ย ย ย if (todosLosCupos.hasOwnProperty(opt.value)) {
ย ย ย ย ย ย ย ย ย ย ย ย const cupo = todosLosCupos[opt.value];
ย ย ย ย ย ย ย ย ย ย ย ย let textoLimpio = opt.textContent.replace(' (Agotado)', '').trim();

ย ย ย ย ย ย ย ย ย ย ย ย if (cupo === 0) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.textContent = textoLimpio + " (Agotado)";
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.style.color = "#b5b5b5";ย
ย ย ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.textContent = textoLimpio;ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย opt.style.color = "black";
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย cupoDiv.textContent = 'Error: ID no encontrado.';
ย ย ย ย ย ย ย ย btnReservar.disabled = true;ย
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย // *** LรGICA DE ENVรO Y MANEJO DE EVENTOS ***
ย ย ย ยย
ย ย ย ย DOM_ELEMENTS.formReserva.addEventListener('submit', async function(event) {
ย ย ย ย ย ย event.preventDefault();ย
ย ย ย ย ย ยย
ย ย ย ย ย ย mostrarMensaje('');ย

ย ย ย ย ย ย const { btnReservar: btn, nombre, telefono, cantidad, fecha, apellidoBot } = DOM_ELEMENTS;

ย ย ย ย ย ย const nombreVal = nombre.value.trim();
ย ย ย ย ย ย const telefonoCliente = telefono.value.trim().replace(/\D/g,'');ย
ย ย ย ย ย ย const cantidadVal = parseInt(cantidad.value);
ย ย ย ย ย ย const fechaVal = fecha.value;ย

ย ย ย ย ย ย // ** 1. VALIDACIONES CLIENTE **
ย ย ย ย ย ย if (!nombreVal || !telefonoCliente || !cantidadVal || !fechaVal) {
ย ย ย ย ย ย ย ย mostrarMensaje('๐ก Completa todos los campos.', 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย if (telefonoCliente.length < MIN_CELULAR_LENGTH || telefonoCliente.length > MAX_CELULAR_LENGTH) {
ย ย ย ย ย ย ย ย mostrarMensaje(`El nรบmero de WhatsApp debe tener entre ${MIN_CELULAR_LENGTH} y ${MAX_CELULAR_LENGTH} dรญgitos (solo nรบmeros, sin 0 ni 15).`, 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }

ย ย ย ย ย ย if (btn.disabled || timerDiv.textContent.includes('00:00')) {
ย ย ย ย ย ย ย ย mostrarMensaje('โฐ Tiempo agotado o evento sin cupo. Actualiza la pรกgina.', 'error');
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย if (apellidoBot.value.trim().length > 0) {
ย ย ย ย ย ย ย ย mostrarMensaje('โ Error de validaciรณn de formulario.', 'error');
ย ย ย ย ย ย ย ย return;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย const cupoActual = todosLosCupos[fechaVal] || 0;
ย ย ย ย ย ย if (cantidadVal > cupoActual) {
ย ย ย ย ย ย ย ย mostrarMensaje(`Solo quedan ${cupoActual} entradas. Ajusta la cantidad.`, 'error');
ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย }
ย ย ย ย ย ย // ** FIN VALIDACIONES CLIENTE **

ย ย ย ย ย ย const formData = new URLSearchParams();
ย ย ย ย ย ย formData.append('accion', 'reservar');
ย ย ย ย ย ย formData.append('nombre', nombreVal);
ย ย ย ย ย ย formData.append('telefono', telefonoCliente);
ย ย ย ย ย ย formData.append('cantidad', cantidadVal);
ย ย ย ย ย ย formData.append('fecha', fechaVal);ย

ย ย ย ย ย ย // Bloquear UI y detener timer
ย ย ย ย ย ย btn.disabled = true;
ย ย ย ย ย ย btn.classList.add('loading');
ย ย ย ย ย ย clearInterval(timerTimeout);ย


ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const data = await fetchData('reservar', {}, 'POST', formData);

ย ย ย ย ย ย ย ย if (data.status === 'OK') {
ย ย ย ย ย ย ย ย ย ย // Mensaje de รฉxito antes de redirigir
ย ย ย ย ย ย ย ย ย ย mostrarMensaje(`โ ยกRESERVA EXITOSA! ID: ${data.id}. Total: $${data.montoTotal}. Redirigiendo a WhatsApp...`, 'exito');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย const mensajeWhatsApp = [
ย ย ย ย ย ย ย ย ย ย ย ย `ยกHola! He realizado una reserva.`,
ย ย ย ย ย ย ย ย ย ย ย ย `*ID de Reserva:* ${data.id}`,
ย ย ย ย ย ย ย ย ย ย ย ย `*Entradas:* ${cantidadVal}`,
ย ย ย ย ย ย ย ย ย ย ย ย `*Monto Total a Pagar:* $${data.montoTotal}`,
ย ย ย ย ย ย ย ย ย ย ย ย ``,
ย ย ย ย ย ย ย ย ย ย ย ย `โญ *LINK DE PAGO:*`,
ย ย ย ย ย ย ย ย ย ย ย ย `${data.linkPago}`,ย
ย ย ย ย ย ย ย ย ย ย ย ย ``,
ย ย ย ย ย ย ย ย ย ย ย ย `*Importante:* El pago debe ser procesado lo antes posible para confirmar la reserva.`
ย ย ย ย ย ย ย ย ย ย ].join('\n');ย

ย ย ย ย ย ย ย ย ย ย const mensajeURL = encodeURIComponent(mensajeWhatsApp);
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย // Redirecciรณn a WhatsApp
ย ย ย ย ย ย ย ย ย ย window.open(`https://wa.me/${MANAGER_WHATSAPP_NUMBER}?text=${mensajeURL}`, '_blank');
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย // Actualizar UI (ocultar formulario y mostrar mensaje final si deseas)
ย ย ย ย ย ย ย ย ย ย DOM_ELEMENTS.formReserva.style.display = 'none';
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย mostrarMensaje('โ ' + (data.message || 'Error desconocido del servidor durante la reserva.'), 'error');
ย ย ย ย ย ย ย ย ย ย // Reestablecer UI
ย ย ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย ย ย btn.classList.remove('loading');
ย ย ย ย ย ย ย ย ย ย startTimer(); // Reiniciar timer
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย } catch(err) {
ย ย ย ย ย ย ย ย mostrarMensaje('โ Error de conexiรณn o red: ' + err.message, 'error');
ย ย ย ย ย ย ย ย btn.disabled = false;
ย ย ย ย ย ย ย ย btn.classList.remove('loading');
ย ย ย ย ย ย ย ย startTimer();ย
ย ย ย ย ย ย }
ย ย ย ย });


ย ย ย ย DOM_ELEMENTS.fecha.addEventListener('change', mostrarCupoSeleccionado);


ย ย ย ย // *** 4. INICIAR LAS FUNCIONES AL CARGAR ***
ย ย ย ย window.addEventListener('load', () => {
ย ย ย ย ย ย cargarNombreObra();ย
ย ย ย ย ย ย startTimer();ย
ย ย ย ย ย ยย
ย ย ย ย ย ย fetchData('obtenerOpciones', { obra: OBRA_FILTRO_NOMBRE })
ย ย ย ย ย ย ย ย .then(data => {
ย ย ย ย ย ย ย ย ย ย if (data.status === 'OK' && Array.isArray(data.eventos)) {
ย ย ย ย ย ย ย ย ย ย ย ย cargarOpcionesEventos(data.eventos);
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย DOM_ELEMENTS.cupoDiv.textContent = 'โ Error al cargar opciones de eventos.';
                        // Muestra el error en el mensaje superior para visibilidad
                        mostrarMensaje(data.message || 'Error crรญtico de conexiรณn con Google Script. Revisa la URL de EXEC_URL y la Implementaciรณn.', 'error');
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย .catch(err => {
ย ย ย ย ย ย ย ย ย ย console.error('Error FATAL al cargar eventos:', err);
ย ย ย ย ย ย ย ย ย ย DOM_ELEMENTS.cupoDiv.textContent = 'Error crรญtico al cargar eventos.';
ย ย ย ย ย ย ย ย ย ย mostrarMensaje('Error de red al conectar con Apps Script. ยฟLa URL de EXEC_URL es correcta?', 'error');
ย ย ย ย ย ย ย ย });
ย ย ย ย });
ย ย </script>
</body>
</html>

