<script>
// *** 1. CONFIGURACIÓN ÚNICA ***
const EXEC_URL = 'https://script.google.com/macros/s/AKfycbw1_-1LFIfXI_yf_5o4ScKXWOQNdBl_pG8nfhoTx-ueyAXy5kPKbByoEPvSCrTTPO77/exec';

// ¡FILTRO CRÍTICO! (Cambia esto a 'Rotos' en rotos.html)
const OBRA_FILTRO_NOMBRE = 'La Jirafa'; 

let timerTimeout; 
let todosLosCupos = {}; 
//  ¡NÚMERO DEL GESTOR (CON CÓDIGO DE PAÍS, SIN EL SIGNO +)
const MANAGER_WHATSAPP_NUMBER = '5493492594940';

/* Función para mostrar mensajes de estado */
function mostrarMensaje(texto, tipo = 'error') {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = texto;
    messageDiv.style.display = 'block';
    messageDiv.className = 'message'; // Reiniciar clase

    if (tipo === 'exito') {
        messageDiv.style.backgroundColor = '#d4edda'; // Fondo verde claro
        messageDiv.style.color = '#155724'; // Texto verde oscuro
    } else if (tipo === 'error') {
        messageDiv.style.backgroundColor = '#f8d7da'; // Fondo rojo claro
        messageDiv.style.color = '#721c24'; // Texto rojo oscuro
    }
    
    // Ocultar el mensaje después de 8 segundos (8000 ms)
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 8000); 
}

/* CARGAR NOMBRE DE OBRA */
async function cargarNombreObra() {
    try {
        const response = await fetch(EXEC_URL + '?accion=obtenerNombre&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE)); 
        const data = await response.json();
        
        if (data.status === 'OK' && data.nombre) {
            const nuevoNombre = 'Reserva Entradas - ' + data.nombre;
            document.title = nuevoNombre;
            document.getElementById('tituloObra').textContent = nuevoNombre;
        } else {
            document.title = 'Reserva de Entradas';
            document.getElementById('tituloObra').textContent = 'Reserva de Entradas';
        }
    } catch(err) {
        console.error('Error al cargar nombre de obra:', err);
    }
}

/* TEMPORIZADOR */
function startTimer() {
    let duration = 5 * 60; 

    function updateTimer() {
        const minutes = parseInt(duration / 60, 10);
        const seconds = parseInt(duration % 60, 10);

        const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
        const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

        document.getElementById('timerDiv').textContent = "⏱️ Tiempo restante: " + displayMinutes + ":" + displaySeconds;

        if (--duration < 0) {
            clearInterval(timerTimeout); 
            document.getElementById('btnReservar').disabled = true;
        }
    }
    
    if (timerTimeout) clearInterval(timerTimeout); 
    timerTimeout = setInterval(updateTimer, 1000);
}

/* CARGAR OPCIONES DEL EVENTO */
function cargarOpcionesEventos(opciones) {
    const select = document.getElementById('fecha');
    select.innerHTML = ''; 
    
    if (opciones.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = "No hay eventos disponibles";
        select.appendChild(opt);
        document.getElementById('cupoDiv').textContent = 'No hay eventos configurados para ' + OBRA_FILTRO_NOMBRE + '.';
        return;
    }

    opciones.forEach(opcion => {
        const opt = document.createElement('option');
        opt.value = opcion.id; 
        opt.textContent = opcion.texto; 
        select.appendChild(opt);
    });
    
    actualizarCupo();
}

/* ACTUALIZAR CUPO */
async function actualizarCupo() {
    const cupoDiv = document.getElementById('cupoDiv');
    
    cupoDiv.textContent = 'Buscando entradas...';
    cupoDiv.classList.add('buscando'); 
    
    try {
        const response = await fetch(EXEC_URL + '?accion=consultarCupo'); 
        const data = await response.json();
        
        cupoDiv.classList.remove('buscando'); 

        if (data.status === 'OK' && data.cupos) {
            todosLosCupos = data.cupos; 
            mostrarCupoSeleccionado(); 
        } else {
            cupoDiv.textContent = 'Error al verificar cupo.';
        }
    } catch(err) {
        console.error('Error al consultar cupo:', err);
        cupoDiv.classList.remove('buscando');
        cupoDiv.textContent = 'Error de conexión.';
    }
}

/* MOSTRAR CUPO SELECCIONADO */
function mostrarCupoSeleccionado() {
    const selectFecha = document.getElementById('fecha');
    const idSeleccionado = selectFecha.value;
    const cupoDiv = document.getElementById('cupoDiv');
    
    if (todosLosCupos.hasOwnProperty(idSeleccionado)) {
        const cupoRestante = todosLosCupos[idSeleccionado];
        cupoDiv.textContent = 'Entradas disponibles: ' + cupoRestante;
    } else {
        cupoDiv.textContent = 'Selecciona una función para ver disponibilidad.';
    }
}


/* BOTON RESERVA (¡ALERTS REMOVIDOS!) */
document.getElementById('btnReservar').onclick = async function() {
    const nombre = document.getElementById('nombre').value.trim();
    const telefono = document.getElementById('telefono').value.trim().replace(/\D/g,''); 
    const cantidad = parseInt(document.getElementById('cantidad').value);
    const fecha = document.getElementById('fecha').value; 

    if (!nombre || !telefono || !cantidad || !fecha) {
        mostrarMensaje('⚠️ Completa todos los campos correctamente.', 'error');
        return;
    }

    const formData = new URLSearchParams();
    formData.append('nombre', nombre);
    formData.append('telefonoCliente', telefono);
    formData.append('cantidad', cantidad);
    formData.append('fecha', fecha); 

    this.disabled = true;
    this.classList.add('loading');
    clearInterval(timerTimeout); 

    try {
        const response = await fetch(EXEC_URL, { method: 'POST', body: formData }); 
        const data = await response.json();

        if (data.status === 'OK') {
            // Muestra mensaje de éxito en la página
            mostrarMensaje(`✅ ¡RESERVA EXITOSA! ID: ${data.id}. Total a pagar: $${data.montoTotal}. Redirigiendo a WhatsApp...`, 'exito');
            
            // Construcción del Mensaje de WhatsApp 
            const mensajeWhatsApp = [
                `¡Hola! Mi reserva es la ID: *${data.id}*.`,
                `Confirmo la reserva de *${cantidad}* entradas.`,
                `El monto total es de *$${data.montoTotal}*.`,
                ``,
                `➡️ *LINK DE PAGO MERCADO PAGO:*`,
                `${data.linkPago}`, 
                ``,
                `*IMPORTANTE:* Si el pago no se realiza en 5 minutos, la reserva puede cancelarse.`
            ].join('\n'); 

            const mensajeURL = encodeURIComponent(mensajeWhatsApp);
            
            // Abre WhatsApp en una nueva pestaña 
            window.open(`https://wa.me/${telefono}?text=${mensajeURL}`, '_blank');
            
            document.getElementById('cupoDiv').textContent = 'Entradas disponibles: ' + data.cupoRestante;
        } else {
            // Muestra mensaje de error en la página
            mostrarMensaje('❌ Error al reservar: ' + data.message, 'error');
            startTimer(); 
        }
        
    } catch(err) {
        // Muestra mensaje de error de conexión en la página
        mostrarMensaje('❌ Error de conexión o red: ' + err.message, 'error');
        startTimer(); 
    }

    this.disabled = false;
    this.classList.remove('loading');
};


document.getElementById('fecha').addEventListener('change', mostrarCupoSeleccionado);


// *** 4. INICIAR LAS FUNCIONES AL CARGAR ***
cargarNombreObra(); 
startTimer(); 
fetch(EXEC_URL + '?accion=obtenerOpciones&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE))
    .then(response => response.json())
    .then(data => cargarOpcionesEventos(data))
    .catch(err => console.error('Error al cargar eventos:', err));
</script>