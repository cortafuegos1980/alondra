<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargando Obra...</title>

<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
    .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

    .timer { background: #ffebee; color: #d32f2f; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 15px; }

    .message { padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; }

    input, select {
        width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;
    }

    button {
        width: 100%; padding: 15px; background: #25D366; color: white;
        border: none; border-radius: 5px; font-size: 16px; font-weight: bold;
        cursor: pointer;
    }

    button.loading { background: #ccc; cursor: not-allowed; }

    .honeypot { display: none; }

    /* Estilo cupo */
    #cupoDiv { font-weight: bold; margin-bottom: 15px; }
</style>
</head>

<body>
<div class="container">
    <h2 id="tituloObra">Cargando Obra...</h2>

    <div class="timer" id="timerDiv">Tiempo restante: 05:00</div>

    <div id="cupoDiv">Cargando disponibilidad...</div>

    <div id="message" class="message"></div>

    <div class="form-group">
        <label>Apellido y Nombre:</label>
        <input type="text" id="nombre">
    </div>

    <div class="form-group">
        <label>Tu WhatsApp:</label>
        <input type="tel" id="telefono" placeholder="Ej: 3412345678">
    </div>

    <div class="form-group">
        <label>Cantidad:</label>
        <input type="number" id="cantidad" min="1" max="10" value="1">
    </div>

    <div class="form-group">
        <label>Fecha del Evento:</label>
        <select id="fecha"></select>
    </div>

    <div class="honeypot">
        <input type="text" id="apellidoBot">
    </div>

    <button id="btnReservar">Reservar</button>
</div>

<script>
/* ------------------- CONFIG ------------------- */
const EXEC_URL = "https://script.google.com/macros/s/AKfycbxY8HbJ2jkGT7gx7YLWkLTL_h-YGRA9uBefYlDI4MU7RH4A2VM5AYMVD5y2KCZgnO4T/exec";
const OBRA = "La Jirafa";
const WHATSAPP_MANAGER = "5493492594940";

let timerInterval;
let cupos = {};

/* ------------------- UTILIDADES ------------------- */
function msg(texto, tipo = "error") {
    const box = document.getElementById("message");

    if (!texto) return (box.style.display = "none");

    box.style.display = "block";
    box.textContent = texto;

    if (tipo === "exito") {
        box.style.background = "#d4edda";
        box.style.color = "#155724";
        setTimeout(() => (box.style.display = "none"), 8000);
    } else {
        box.style.background = "#f8d7da";
        box.style.color = "#721c24";
        box.style.fontWeight = "bold";
        box.style.textTransform = "uppercase";
    }
}

/* ------------------- TIMER ------------------- */
function startTimer() {
    let t = 300;

    const show = () => {
        const m = String(Math.floor(t / 60)).padStart(2, "0");
        const s = String(t % 60).padStart(2, "0");
        document.getElementById("timerDiv").textContent = `Tiempo restante: ${m}:${s}`;

        if (t-- <= 0) {
            clearInterval(timerInterval);
            document.getElementById("btnReservar").disabled = true;
        }
    };

    clearInterval(timerInterval);
    timerInterval = setInterval(show, 1000);
}

/* ------------------- NOMBRE DE OBRA ------------------- */
async function cargarNombreObra() {
    try {
        const r = await fetch(`${EXEC_URL}?accion=obtenerNombre&obra=${encodeURIComponent(OBRA)}`);
        const data = await r.json();

        const nombre = data?.nombre || OBRA;
        document.title = "Reserva Entradas - " + nombre;
        document.getElementById("tituloObra").textContent = document.title;
    } catch { }
}

/* ------------------- CUPO ------------------- */
function actualizarSelect() {
    const sel = document.getElementById("fecha");
    sel.innerHTML = "";

    Object.entries(cupos).forEach(([id, cant]) => {
        const opt = document.createElement("option");
        opt.value = id;

        const base = id.split("_")[1]; // texto original enviado por Apps Script
        opt.textContent = cant === 0 ? `${base} (Agotado)` : base;

        opt.style.color = cant === 0 ? "#9e9e9e" : "black";

        sel.appendChild(opt);
    });

    mostrarCupo();
}

function mostrarCupo() {
    const id = document.getElementById("fecha").value;
    const cant = cupos[id];
    const box = document.getElementById("cupoDiv");

    if (cant === 0) {
        box.innerHTML = `<span style="color:red; font-size:20px;">¡ENTRADAS AGOTADAS!</span>`;
    } else {
        box.textContent = "Entradas disponibles: " + cant;
    }
}

/* ------------------- RESERVA ------------------- */
async function reservar() {
    msg("");

    const nombre = document.getElementById("nombre").value.trim();
    const tel = document.getElementById("telefono").value.trim().replace(/\D/g, "");
    const cant = Number(document.getElementById("cantidad").value);
    const fecha = document.getElementById("fecha").value;

    if (!nombre || !tel || !cant || !fecha) return msg("Completa todos los campos.");

    if (document.getElementById("apellidoBot").value.trim()) return msg("Error de validación.");

    const form = new URLSearchParams();
    form.append("accion", "reservar");
    form.append("nombre", nombre);
    form.append("telefono", tel);
    form.append("cantidad", cant);
    form.append("fecha", fecha);

    const btn = document.getElementById("btnReservar");
    btn.disabled = true;
    btn.classList.add("loading");
    clearInterval(timerInterval);

    try {
        const r = await fetch(EXEC_URL, { method: "POST", body: form });
        const data = await r.json();

        if (data.status === "OK") {
            msg(`Reserva exitosa. Total: $${data.montoTotal}`, "exito");

            const texto = `Reserva ID: ${data.id}\nCantidad: ${cant}\nTotal: $${data.montoTotal}\n\nLink de pago:\n${data.linkPago}`;
            window.open(`https://wa.me/${WHATSAPP_MANAGER}?text=${encodeURIComponent(texto)}`);

            cupos[fecha] = data.cupoRestante;
            actualizarSelect();
        } else msg("❌ " + data.message);
    } catch {
        msg("❌ Error de conexión.");
        startTimer();
    }

    btn.disabled = false;
    btn.classList.remove("loading");
}

/* ------------------- INIT ------------------- */
async function init() {
    cargarNombreObra();
    startTimer();

    try {
        const r = await fetch(`${EXEC_URL}?accion=obtenerOpciones&obra=${encodeURIComponent(OBRA)}`);
        const data = await r.json();

        cupos = data.cupos || {};
        actualizarSelect();
    } catch {
        document.getElementById("cupoDiv").textContent = "Error cargando eventos.";
    }
}

document.getElementById("btnReservar").onclick = reservar;
document.getElementById("fecha").onchange = mostrarCupo;

init();
</script>
</body>
</html>
