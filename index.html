<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Reserva de Entradas</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 500px;
            margin-top: 50px;
        }
        .card {
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h2 {
            font-weight: 700;
            color: #343a40;
            margin-bottom: 20px;
            text-align: center;
        }
        .form-group label {
            font-weight: 500;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            transition: background-color 0.3s;
            width: 100%;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        #mensajeError, #mensajeExito {
            display: none;
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #mensajeError {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #mensajeExito {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        #infoPanel {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            background-color: #e9ecef;
        }
        .info-item {
            text-align: center;
            font-size: 1.1rem;
        }
        .info-item strong {
            display: block;
            font-size: 1.5rem;
            color: #007bff;
        }
        #precioUnitario {
            color: #28a745;
            font-weight: bold;
            font-size: 1.6rem;
            margin-top: 5px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Estilo para el panel de precio/tiempo/cupo */
        #detallesPanel {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #fff;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Tres columnas */
            gap: 10px;
            text-align: center;
        }
        .detalle-item {
            padding: 5px 0;
            border-radius: 3px;
        }
        .detalle-item h5 {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 3px;
        }
        .detalle-item span {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .detalle-item.precio span {
            color: #28a745;
        }
        .detalle-item.cupo span {
            color: #007bff;
        }
        .detalle-item.tiempo span {
            color: #dc3545;
        }
        /* El spinner que se muestra mientras carga */
        #precioLoading {
            text-align: center;
            padding: 10px;
        }

    </style>
</head>
<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2 id="obraTitulo">Reserva Entradas - Cargando...</h2>
            
            <div id="mensajeError"></div>
            <div id="mensajeExito"></div>

            <div id="detallesPanel">
                <div class="detalle-item precio">
                    <h5>PRECIO POR UNIDAD</h5>
                    <div id="precioDisplay">
                        <span id="precioValor">...</span>
                        <div id="precioLoading" class="text-secondary" style="font-size: 0.8rem;">Cargando precio...</div>
                    </div>
                </div>
                <div class="detalle-item tiempo">
                    <h5>TIEMPO RESTANTE</h5>
                    <span id="tiempoRestante">00:00</span>
                </div>
                <div class="detalle-item cupo">
                    <h5>DISPONIBLES</h5>
                    <span id="cupoDisponible">...</span>
                </div>
            </div>

            <form id="reservaForm">
                
                <div class="form-group">
                    <label for="nombre">Apellido y Nombre:</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" required placeholder="Ej: Juan Pérez">
                </div>
                
                <div class="form-group">
                    <label for="telefono">Tu WhatsApp (Solo números, sin 0 ni 15):</label>
                    <input type="tel" class="form-control" id="telefono" name="telefono" required placeholder="Ej: 3512345678" pattern="[0-9]{8,15}">
                </div>

                <div class="form-group">
                    <label for="cantidad">Cantidad:</label>
                    <input type="number" class="form-control" id="cantidad" name="cantidad" required min="1" max="10" value="1">
                </div>

                <div class="form-group">
                    <label for="fecha">Fecha del Evento:</label>
                    <select class="form-control" id="fecha" name="fecha" required disabled>
                        <option value="">Cargando fechas...</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success" id="btnReservar">Reservar</button>
            </form>
        </div>
    </div>

    <script>
        // *** CONFIGURACIÓN Y VARIABLES GLOBALES ***
        const URL_PARAM_OBRA = new URLSearchParams(window.location.search).get('obra') || 'La Jirafa'; // Obra por defecto
        let timerInterval;
        let cuposActuales = {};

        // *** FUNCIONES DE UTILIDAD Y UI ***

        function mostrarMensaje(id, mensaje, tipo) {
            const element = document.getElementById(id);
            element.innerHTML = mensaje;
            element.className = 'alert ' + (tipo === 'exito' ? 'alert-success' : 'alert-danger');
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 6000);
        }

        function setPrecioDisplay(precio, loading = false) {
            const precioValor = document.getElementById('precioValor');
            const precioLoading = document.getElementById('precioLoading');
            
            if (loading) {
                precioValor.style.display = 'none';
                precioLoading.style.display = 'block';
                precioValor.textContent = '...';
            } else {
                precioValor.textContent = `$${parseFloat(precio).toLocaleString('es-AR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
                precioValor.style.display = 'block';
                precioLoading.style.display = 'none';
            }
        }

        function setCupoDisplay(cupo) {
            const cupoDisponible = document.getElementById('cupoDisponible');
            cupoDisponible.textContent = cupo !== null ? `${cupo} disp.` : '...';
        }
        
        // ** Contador de tiempo (Reiniciar al cargar la página) **
        function iniciarContador(minutos = 5) {
            clearInterval(timerInterval);
            let tiempoRestante = minutos * 60;
            const display = document.getElementById('tiempoRestante');

            timerInterval = setInterval(() => {
                const minutos = parseInt(tiempoRestante / 60, 10);
                const segundos = parseInt(tiempoRestante % 60, 10);

                display.textContent = 
                    (minutos < 10 ? "0" + minutos : minutos) + ":" + 
                    (segundos < 10 ? "0" + segundos : segundos);

                if (--tiempoRestante < 0) {
                    tiempoRestante = 0;
                    clearInterval(timerInterval);
                    mostrarMensaje('mensajeError', 'El tiempo de la sesión expiró. Recarga la página.', 'error');
                    document.getElementById('btnReservar').disabled = true;
                }
            }, 1000);
        }


        // *** COMUNICACIÓN CON APPS SCRIPT ***

        /**
         * Llama al Apps Script con una acción y parámetros.
         */
        async function llamarAppsScript(accion, params = {}) {
            const url = '<?= ScriptApp.getService().getUrl() ?>';
            const query = new URLSearchParams({ accion, ...params }).toString();
            try {
                const response = await fetch(`${url}?${query}`);
                return response.json();
            } catch (error) {
                console.error('Error al comunicarse con Apps Script:', error);
                mostrarMensaje('mensajeError', 'Error de conexión con el servidor. Intenta más tarde.', 'error');
                return { status: 'ERROR', message: 'Error de red.' };
            }
        }

        /**
         * 1. Carga las opciones de fecha y el título de la obra.
         * 2. Consulta el cupo inicial.
         * 3. Llama a obtenerPrecio para el ID seleccionado.
         */
        async function obtenerDetallesObra() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            const fechaSelect = document.getElementById('fecha');
            
            // 1. Obtener Opciones y Nombre
            const [opciones, nombreObra] = await Promise.all([
                llamarAppsScript('obtenerOpciones', { obra: URL_PARAM_OBRA }),
                llamarAppsScript('obtenerNombre', { obra: URL_PARAM_OBRA })
            ]);

            document.getElementById('obraTitulo').textContent = `Reserva Entradas - ${nombreObra.nombre}`;
            
            // Rellenar el Select
            fechaSelect.innerHTML = '';
            opciones.forEach(opcion => {
                const option = document.createElement('option');
                option.value = opcion.id;
                option.textContent = opcion.texto;
                fechaSelect.appendChild(option);
            });
            fechaSelect.disabled = opciones.length === 0;

            if (opciones.length === 0) {
                mostrarMensaje('mensajeError', 'No hay funciones disponibles para esta obra.', 'error');
                document.getElementById('btnReservar').disabled = true;
            }

            // 2. Consultar Cupo
            const cupos = await llamarAppsScript('consultarCupo');
            cuposActuales = cupos.cupos || {};
            
            // 3. Cargar Precio y Cupo para la primera opción
            if (fechaSelect.value) {
                await actualizarInfoEvento(fechaSelect.value);
            } else {
                setPrecioDisplay('...');
                setCupoDisplay(0);
            }
            
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        /**
         * Obtiene el precio unitario y actualiza el cupo para un evento (ID).
         */
        async function actualizarInfoEvento(eventoId) {
            if (!eventoId) return;

            setPrecioDisplay(null, true); // Mostrar cargando

            // 1. Obtener Precio
            const resultadoPrecio = await llamarAppsScript('obtenerPrecioPorId', { id: eventoId });
            
            if (resultadoPrecio.status === 'OK') {
                setPrecioDisplay(resultadoPrecio.precio);
            } else {
                setPrecioDisplay('Error');
                console.error('Error al obtener precio:', resultadoPrecio.message);
            }

            // 2. Actualizar Cupo
            const cupo = cuposActuales[eventoId] || 0;
            setCupoDisplay(cupo);
        }


        /**
         * Maneja el envío del formulario de reserva.
         */
        async function manejarReserva(event) {
            event.preventDefault();
            document.getElementById('btnReservar').disabled = true;
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            const form = event.target;
            const data = new FormData(form);
            const params = {};
            for (let [key, value] of data.entries()) {
                params[key] = value;
            }
            params.accion = 'reservar';

            const resultado = await llamarAppsScript('reservar', params);
            
            document.getElementById('loadingOverlay').style.display = 'none';

            if (resultado.status === 'OK') {
                const mensaje = `¡Reserva Exitosa! ID: <strong>${resultado.id}</strong>. Debes pagar <strong>$${resultado.montoTotal.toLocaleString('es-AR')}</strong>. <a href="${resultado.linkPago}" target="_blank" class="alert-link">Haz clic aquí para pagar ahora.</a>`;
                mostrarMensaje('mensajeExito', mensaje, 'exito');
                
                // Actualizar UI después de la reserva exitosa
                iniciarContador(5); // Reiniciar timer
                
                // Actualizar cupo local y en la UI
                cuposActuales[params.fecha] = resultado.cupoRestante;
                setCupoDisplay(resultado.cupoRestante);
                
                // Limpiar solo campos no esenciales
                form.elements['cantidad'].value = 1;

            } else {
                mostrarMensaje('mensajeError', `Error: ${resultado.message}`, 'error');
            }
            
            document.getElementById('btnReservar').disabled = false;
        }


        // *** INICIALIZACIÓN Y LISTENERS ***

        document.addEventListener('DOMContentLoaded', () => {
            // Iniciar el contador al cargar la página
            iniciarContador(5); 

            // Cargar datos iniciales
            obtenerDetallesObra();

            // Listener para el formulario de reserva
            document.getElementById('reservaForm').addEventListener('submit', manejarReserva);

            // Listener para cuando se cambia la fecha del evento
            document.getElementById('fecha').addEventListener('change', (event) => {
                actualizarInfoEvento(event.target.value);
            });
        });

    </script>
</body>
</html>
