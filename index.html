<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cargando Obra...</title>
<style>
Â  Â  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
Â  Â  .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
Â  Â  .timer { background: #ffebee; color: #d32f2f; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 15px; }
Â  Â  .form-group { margin-bottom: 15px; }
Â  Â  label { display: block; margin-bottom: 5px; font-weight: bold; }
Â  Â  input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
Â  Â  button { width: 100%; padding: 15px; background: #25D366; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
Â  Â  button.loading { background: #cccccc; cursor: not-allowed; }
Â  Â  .message { padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }
Â  Â  .cupo { margin-bottom: 15px; font-weight: bold; }
Â  Â  .buscando {	
Â  Â  Â  Â  background: #e6ffe6;	
Â  Â  Â  Â  color: #155724;	
Â  Â  Â  Â  border: 1px solid #c3e6cb;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  }
Â  Â  .honeypot {
Â  Â  Â  Â  display: none;	
Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  left: -9999px;	
Â  Â  }
Â  Â  .agotado-rojo {
Â  Â  Â  Â  color: #D32F2F; 
Â  Â  Â  Â  font-weight: bold;
Â  Â  }
</style>
</head>
<body>
<div class="container">
Â  Â  <h2 id="tituloObra">Cargando Obra...</h2>
Â  Â Â 
Â  Â  <div class="timer" id="timerDiv">Tiempo restante: 5:00</div>
Â  Â  <div class="cupo buscando" id="cupoDiv">Cargando eventos...</div>
Â  Â  <div id="message" class="message"></div>
Â  Â Â 
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Apellido y Nombre:</label>
Â  Â  Â  Â  <input type="text" id="nombre" placeholder="Ej: MarÃ­a GonzÃ¡lez">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Tu WhatsApp (SÃ³lo nÃºmeros, sin 0 ni 15):</label>
Â  Â  Â  Â  <input type="tel" id="telefono" placeholder="Ej: 3415123456">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Cantidad:</label>
Â  Â  Â  Â  <input type="number" id="cantidad" min="1" max="10" value="1">
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label>Fecha del Evento:</label>
Â  Â  Â  Â  <select id="fecha">
Â  Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div class="form-group honeypot">
Â  Â  Â  Â  <label for="apellidoBot">No llenar este campo:</label>
Â  Â  Â  Â  <input type="text" id="apellidoBot" name="apellidoBot">
Â  Â  </div>

Â  Â  <button id="btnReservar">Reservar</button>
</div> <script>
// *** 1. CONFIGURACIÃ“N CRUCIAL ***
// ðŸ’¡ 1. REVISA TU URL DE APPS SCRIPT.
Â  Â  const EXEC_URL = 'https://script.google.com/macros/s/AKfycbyCoBk8cOyzJZEHESWk5nAuio3LDCAe9fCzi-lK6kR0XQl9dtUGDD7kVNWt7Ipdqec9/exec';

// Filtro de la obra
const OBRA_FILTRO_NOMBRE = 'La Jirafa';Â 

// ðŸ’¡ 2. REVISA TU NÃšMERO DE GESTOR
const MANAGER_WHATSAPP_NUMBER = '5493492594940';Â 

let timerTimeout;Â 
let todosLosCupos = {};Â 

/* FunciÃ³n para mostrar mensajes de estado */
function mostrarMensaje(texto, tipo = 'error') {
Â  Â  const messageDiv = document.getElementById('message');
Â  Â Â 
Â  Â  if (!texto) {
Â  Â  Â  Â  messageDiv.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  messageDiv.textContent = texto;
Â  Â  messageDiv.style.display = 'block';
Â  Â  messageDiv.className = 'message';Â 

Â  Â  if (tipo === 'exito') {
Â  Â  Â  Â  messageDiv.style.backgroundColor = '#d4edda';Â 
Â  Â  Â  Â  messageDiv.style.color = '#155724';Â 
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  messageDiv.style.display = 'none';
Â  Â  Â  Â  }, 8000);Â 

Â  Â  Â  Â  } else if (tipo === 'error') {
Â  Â  messageDiv.style.backgroundColor = '#f8d7da';
Â  Â  messageDiv.style.color = '#721c24';
Â  Â  messageDiv.style.fontWeight = 'bold';
Â  Â  messageDiv.style.textTransform = 'uppercase';
Â  Â  }
}

/* CARGAR NOMBRE DE OBRA */
function actualizarTituloObra(nombre) {
    const nuevoNombre = 'Reserva Entradas - ' + nombre;
    document.title = nuevoNombre;
    document.getElementById('tituloObra').textContent = nuevoNombre;
}

/* TEMPORIZADOR */
function startTimer() {
Â  Â  let duration = 5 * 60;Â 

Â  Â  function updateTimer() {
Â  Â  Â  Â  const minutes = parseInt(duration / 60, 10);
Â  Â  Â  Â  const seconds = parseInt(duration % 60, 10);

Â  Â  Â  Â  const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
Â  Â  Â  Â  const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

Â  Â  Â  Â  document.getElementById('timerDiv').textContent = "â±ï¸ Tiempo restante: " + displayMinutes + ":" + displaySeconds;Â 

Â  Â  Â  Â  if (--duration < 0) {
Â  Â  Â  Â  Â  Â  clearInterval(timerTimeout);Â 
Â  Â  Â  Â  Â  Â  document.getElementById('btnReservar').disabled = true;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  if (timerTimeout) clearInterval(timerTimeout);Â 
Â  Â  timerTimeout = setInterval(updateTimer, 1000);
}

/* CARGAR OPCIONES DEL EVENTO (SIMPLIFICADA) */
function cargarOpcionesEventos(opciones) {
Â  Â  const select = document.getElementById('fecha');
Â  Â  select.innerHTML = '';

Â  Â  if (opciones.length === 0) {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.textContent = "No hay eventos disponibles";
        opt.value = "";
Â  Â  Â  Â  select.appendChild(opt);
Â  Â  Â  Â  document.getElementById('cupoDiv').textContent =
Â  Â  Â  Â  Â  Â  'No hay eventos configurados para ' + OBRA_FILTRO_NOMBRE + '.';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  opciones.forEach(opcion => {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = opcion.id;
Â  Â  Â  Â  opt.textContent = opcion.texto; // Solo texto base
Â  Â  Â  Â  select.appendChild(opt);
Â  Â  });

Â  Â  mostrarCupoSeleccionado(); 
}


/* MOSTRAR CUPO SELECCIONADO */
function mostrarCupoSeleccionado() {
Â  Â  const selectFecha = document.getElementById('fecha');
Â  Â  const idSeleccionado = selectFecha.value;
Â  Â  const cupoDiv = document.getElementById('cupoDiv');

Â  Â  cupoDiv.classList.remove('buscando');Â 

Â  Â  if (todosLosCupos.hasOwnProperty(idSeleccionado)) {
Â  Â  Â  Â  const cupoRestante = todosLosCupos[idSeleccionado];

Â  Â  Â  Â  // ** LÃ“GICA DE TEXTO Y COLOR ROJO **
Â  Â  Â  Â  if (cupoRestante === 0) {
Â  Â  Â  Â  Â  Â  cupoDiv.textContent = 'Â¡ENTRADAS AGOTADAS!';
Â  Â  Â  Â  Â  Â  cupoDiv.classList.add('agotado-rojo');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  cupoDiv.textContent = 'Entradas disponibles: ' + cupoRestante;
Â  Â  Â  Â  Â  Â  cupoDiv.classList.remove('agotado-rojo');
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Recorre todas las opciones y actualiza texto + color
Â  Â  Â  Â  const opciones = selectFecha.options;
Â  Â  Â  Â  for (let opt of opciones) {
Â  Â  Â  Â  Â  Â  const cupo = todosLosCupos[opt.value];
            
            if (typeof cupo === 'undefined' || opt.value === "") continue; 

Â  Â  Â  Â  Â  Â  if (cupo === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = opt.textContent.split(" (")[0] + " (Agotado)";
Â  Â  Â  Â  Â  Â  Â  Â  opt.style.color = "#b5b5b5"; // gris claro
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  opt.textContent = opt.textContent.split(" (")[0];
Â  Â  Â  Â  Â  Â  Â  Â  opt.style.color = "black";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  cupoDiv.textContent = 'Selecciona una funciÃ³n para ver disponibilidad.';
Â  Â  }
}

/* BOTON RESERVA */
document.getElementById('btnReservar').onclick = async function() {
Â  Â  mostrarMensaje('');Â 

Â  Â  const nombre = document.getElementById('nombre').value.trim();
Â  Â  const telefonoCliente = document.getElementById('telefono').value.trim().replace(/\D/g,'');Â 
Â  Â  const cantidad = parseInt(document.getElementById('cantidad').value);
Â  Â  const fecha = document.getElementById('fecha').value;Â 

Â  Â  if (!nombre || !telefonoCliente || !cantidad || !fecha) {
Â  Â  Â  Â  mostrarMensaje('ðŸ’¡ Completa todos los campos.', 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // VALIDACIÃ“N HONEYPOT (ANTI-SPAM)
Â  Â  const apellidoBot = document.getElementById('apellidoBot').value.trim();
Â  Â  if (apellidoBot.length > 0) {
Â  Â  Â  Â  mostrarMensaje('âŒ Error de validaciÃ³n de formulario.', 'error');
Â  Â  Â  Â  return;Â 
Â  Â  }

Â  Â  const formData = new URLSearchParams();
Â  Â  formData.append('accion', 'reservar');
Â  Â  formData.append('nombre', nombre);
Â  Â  formData.append('telefono', telefonoCliente);
Â  Â  formData.append('cantidad', cantidad);
Â  Â  formData.append('fecha', fecha);Â 

Â  Â  this.disabled = true;
Â  Â  this.classList.add('loading');
Â  Â  clearInterval(timerTimeout);Â 

Â  Â  try {
Â  Â  Â  Â  const response = await fetch(EXEC_URL, { method: 'POST', body: formData });Â 
Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  if (data.status === 'OK') {
Â  Â  Â  Â  Â  Â  mostrarMensaje(`âœ… Â¡RESERVA EXITOSA! ID: ${data.id}. Total a pagar: $${data.montoTotal}. Redirigiendo a WhatsApp...`, 'exito');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ConstrucciÃ³n del Mensaje de WhatsApp (Mejorado con el nombre)
Â  Â  Â  Â  Â  Â  const mensajeWhatsApp = [
Â  Â  Â  Â  Â  Â  Â  Â  `Â¡Hola! Soy *${nombre}* (ID: ${data.id}).`,
Â  Â  Â  Â  Â  Â  Â  Â  `Confirmo la reserva de *${cantidad}* entradas.`,
Â  Â  Â  Â  Â  Â  Â  Â  `Mi telÃ©fono (Cliente) es: *${telefonoCliente}*`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  `El monto total es de *$${data.montoTotal}*.`,
Â  Â  Â  Â  Â  Â  Â  Â  ``,
Â  Â  Â  Â  Â  Â  Â  Â  `â­ *LINK DE PAGO MERCADO PAGO:*`,
Â  Â  Â  Â  Â  Â  Â  Â  `${data.linkPago}`,Â 
Â  Â  Â  Â  Â  Â  Â  Â  ``,
Â  Â  Â  Â  Â  Â  Â  Â  `*IMPORTANTE:* Si el pago no se realiza en 5 minutos, la reserva puede cancelarse.`
Â  Â  Â  Â  Â  Â  ].join('\n');Â 

Â  Â  Â  Â  Â  Â  const mensajeURL = encodeURIComponent(mensajeWhatsApp);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Abre WhatsApp con el nÃºmero del Gestor
Â  Â  Â  Â  Â  Â  window.open(`https://wa.me/${MANAGER_WHATSAPP_NUMBER}?text=${mensajeURL}`, '_blank');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Actualizamos el cupo localmente y el indicador
Â  Â  Â  Â  Â  Â  todosLosCupos[fecha] = data.cupoRestante; 
Â  Â  Â  Â  Â  Â  mostrarCupoSeleccionado();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  mostrarMensaje('âŒ ' + data.message, 'error');
Â  Â  Â  Â  Â  Â  startTimer();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  } catch(err) {
Â  Â  Â  Â  mostrarMensaje('âŒ Error de conexiÃ³n o red: ' + err.message, 'error');
Â  Â  Â  Â  startTimer();Â 
Â  Â  }

Â  Â  this.disabled = false;
Â  Â  this.classList.remove('loading');
};


document.getElementById('fecha').addEventListener('change', mostrarCupoSeleccionado);


// *** 4. INICIAR LA CARGA INICIAL (OPTIMIZADA) ***
startTimer();Â 

fetch(EXEC_URL + '?accion=obtenerConfigInicial&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE))
Â  Â  .then(response => response.json())
Â  Â  .then(data => {
Â  Â  Â  Â  if (data.status === 'OK' && Array.isArray(data.opciones)) {
Â  Â  Â  Â  Â  Â  // 1. TÃ­tulo
Â  Â  Â  Â  Â  Â  actualizarTituloObra(data.nombre || 'Reserva de Entradas');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 2. Cupos globales
Â  Â  Â  Â  Â  Â  todosLosCupos = data.cupos;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. Opciones y mostrar cupo
Â  Â  Â  Â  Â  Â  cargarOpcionesEventos(data.opciones); 

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error(data.message || 'Error al procesar los datos del servidor. (Â¿Despliegue correcto?)');
Â  Â  Â  Â  }
Â  Â  })
Â  Â  .catch(err => {
Â  Â  Â  Â  console.error('Error FATAL al cargar configuraciÃ³n inicial:', err);
Â  Â  Â  Â  document.getElementById('cupoDiv').textContent = 'Error crÃ­tico: Verifique el despliegue de Apps Script.';
Â  Â  });
</script>
</body>
</html>
