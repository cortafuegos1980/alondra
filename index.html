<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reserva Entradas - La Jirafa</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .timer { background: #ffebee; color: #d32f2f; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 15px; }
  .form-group { margin-bottom: 15px; }
  label { display: block; margin-bottom: 5px; font-weight: bold; }
  input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
  button { width: 100%; padding: 15px; background: #25D366; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
  button.loading { background: #cccccc; cursor: not-allowed; }
  .message { padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }
  .cupo { margin-bottom: 15px; font-weight: bold; }
</style>
</head>
<body>
<div class="container">
  <h2>Reserva Entradas - La Jirafa</h2>
  
  <div class="timer" id="timerDiv">Tiempo restante: 5:00</div>
  <div class="cupo" id="cupoDiv">Entradas disponibles: 150</div>
  <div id="message" class="message"></div>
  
  <div class="form-group">
    <label>Apellido y Nombre:</label>
    <input type="text" id="nombre" placeholder="Ej: Maria Gonzalez">
  </div>

  <div class="form-group">
    <label>Tu WhatsApp (solo números):</label>
    <input type="text" id="telefono" placeholder="Ej: 3415123456">
  </div>

  <div class="form-group">
    <label>Cantidad de Entradas (max. 10):</label>
    <input type="number" id="cantidad" min="1" max="10" value="1">
  </div>

  <div class="form-group">
    <label>Fecha del Evento:</label>
    <select id="fecha">
      <option value="Viernes 20:30">Viernes 20:30</option>
      <option value="Sábado 21:00">Sábado 21:00</option>
      <option value="Domingo 19:00">Domingo 19:00</option>
    </select>
  </div>

  <button id="btnReservar">Enviar Reserva por WhatsApp</button>
</div>

<script>
const EXEC_URL = 'https://corsproxy.io/?https://script.google.com/macros/s/AKfycbw1_-1LFIfXI_yf_5o4ScKXWOQNdBl_pG8nfhoTx-ueyAXy5kPKbByoEPvSCrTTPO77/exec';

let tiempoRestante = 300;
let temporizadorActivo = true;

function actualizarTemporizador() {
  if (!temporizadorActivo) return;
  const minutos = Math.floor(tiempoRestante / 60);
  const segundos = tiempoRestante % 60;
  document.getElementById('timerDiv').textContent = 'Tiempo restante: ' + minutos + ':' + (segundos < 10 ? '0' : '') + segundos;

  if (tiempoRestante <= 0) {
    temporizadorActivo = false;
    alert('El tiempo se agotó, vas a ser redirigido.');
    window.location.href = 'https://www.google.com';
  } else {
    tiempoRestante--;
    setTimeout(actualizarTemporizador, 1000);
  }
}
actualizarTemporizador();

async function actualizarCupo() {
  try {
    const response = await fetch(EXEC_URL);
    const data = await response.json();
    if (data.status === 'OK' && data.cupoRestante !== undefined) {
      document.getElementById('cupoDiv').textContent = 'Entradas disponibles: ' + data.cupoRestante;
    }
  } catch(err) {
    console.error('Error al consultar cupo:', err);
  }
}
actualizarCupo();

document.getElementById('btnReservar').onclick = async function() {
  const nombre = document.getElementById('nombre').value.trim();
  const telefono = document.getElementById('telefono').value.trim().replace(/\D/g,'');
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const fecha = document.getElementById('fecha').value;

  if (!nombre || !telefono || !cantidad) {
    alert('Completa todos los campos correctamente.');
    return;
  }

  const formData = new URLSearchParams();
  formData.append('nombre', nombre);
  formData.append('telefonoCliente', telefono);
  formData.append('cantidad', cantidad);
  formData.append('fecha', fecha);

  this.disabled = true;
  this.classList.add('loading');

  try {
    const response = await fetch(EXEC_URL, { method: 'POST', body: formData });
    const data = await response.json();

    if (data.status === 'OK') {
  alert(`Reserva confirmada: ${data.id}\nCupo restante: ${data.cupoRestante}`);
  const mensaje = encodeURIComponent(`Hola! Confirmo mi reserva ${data.id} de ${cantidad} entradas para La Jirafa.`);
  window.open(`https://wa.me/${telefono}?text=${mensaje}`, '_blank');
  actualizarCupo(); // ← ESTA LÍNEA DEBE ESTAR
} else {
  alert(data.message);
}
  } catch(err) {
    alert('Error al enviar reserva: ' + err.message);
  }

  this.disabled = false;
  this.classList.remove('loading');
};
</script>
</body>
</html>
