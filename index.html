<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva Entradas</title>
    
    <style>
        /* Estilos Globales */
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .message { padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; }

        /* Anti-spam */
        .honeypot { display: none; visibility: hidden; height: 0; width: 0; position: absolute; left: -9999px; }

        /* --- ESTILOS COMPACTOS FINALES (3 COLUMNAS UNIFORMES) --- */

        /* Contenedor principal para organizar las 3 cajas lado a lado */
        #contenedor-superior {
            display: flex;
            justify-content: space-between;
            align-items: stretch; 
            flex-wrap: wrap; 
            margin-bottom: 20px;
        }

        /* Aplica a las cajas de Tiempo y Cupo */
        .caja-estado-superior {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9; 
            margin: 5px;
            text-align: center;
            flex-grow: 1; 
            flex-basis: 0; 
        }

        /* Estilo de la caja de Precio */
        .precio-caja {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #f9f9f9; 
            font-size: 0.9em;
            color: #555; 
            font-weight: 600; 
            flex-grow: 1;
            flex-basis: 0; 
            margin: 5px;
            text-align: center;
        }

        .precio-monto {
            font-size: 1.2em; 
            color: #000; 
            display: block;
            margin-top: 3px; 
            font-weight: bold;
        }

        /* Estilo para el texto dentro de la caja de estado */
        .info-estado {
            font-size: 0.9em;
            font-weight: bold;
            margin: 3px 0; 
        }

        .agotado-rojo {
            color: #D32F2F; 
            font-weight: bold;
        }

        /* ESTILOS DEL BOT√ìN RESERVAR */
        button { 
            width: 100%; 
            padding: 15px; 
            background: #25D366; /* Verde de WhatsApp (activo) */
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.3s; /* A√±adido para un cambio de color suave */
        }
        
        /* ESTILO PARA CUANDO EL BOT√ìN EST√â DESHABILITADO (Tiempo agotado o Cupo 0) */
        button:disabled {
            background: #cccccc; /* Gris claro */
            color: #666666;      /* Texto gris oscuro */
            cursor: not-allowed; 
            opacity: 0.8;        /* Opcional: baja un poco la opacidad */
            box-shadow: none;
        }
        
        button.loading { /* Estilo para cuando est√° enviando datos */
            background: #cccccc; 
            cursor: not-allowed; 
        }
/* ... dentro de tu bloque <style> ... */

/* Estilo general del mensaje */
.message { 
    padding: 12px; /* Un poco m√°s de espacio */
    border-radius: 8px; /* Bordes m√°s suaves */
    margin: 15px 5px 20px 5px; /* Margen para separarlo del formulario y las cajas */
    display: none; 
    text-align: center; /* Centramos el texto */
    font-size: 1.0em;
}

/* Estilo espec√≠fico para errores (rojo) */
.message[style*="background-color: rgb(248, 215, 218)"] { /* Este es el color del error #f8d7da */
    border: 1px solid #f5c6cb; /* Borde suave para definirlo */
    font-weight: bold;
    text-transform: none; /* Quitamos el uppercase que no se ve√≠a prolijo */
}
        
    </style>
</head>
<body>
    
    <div class="container">
        <h2 id="tituloObra">Cargando Obra...</h2>

        <div id="contenedor-superior">
            
            <div id="precioUnitario" class="precio-caja">
                <span style="font-size:0.9em; display:block;">VALOR</span> 
                <span class="precio-monto">Cargando...</span>
            </div> 
            
            <div id="caja-cupo" class="caja-estado-superior">
                <div id="cupoDiv" class="info-estado">Cargando cupo...</div>
            </div>
            
            <div id="caja-tiempo" class="caja-estado-superior">
                <div id="timerDiv" class="info-estado">‚è±Ô∏è 05:00</div>
            </div>
            
        </div>
        <div id="message" class="message"></div>
        
        <div class="form-group">
            <label>Apellido y Nombre:</label>
            <input type="text" id="nombre" placeholder="Ej: Mar√≠a Gonz√°lez">
        </div>

        <div class="form-group">
            <label>Tu WhatsApp (Sin 0 ni 15):</label>
            <input type="tel" id="telefono" placeholder="Ej: 3415123456" onkeypress="return isNumberKey(event)">
        </div>

        <div class="form-group">
            <label>Cantidad:</label>
            <input type="number" id="cantidad" min="1" max="10" value="1">
        </div>

        <div class="form-group">
            <label>Fecha del Evento:</label>
            <select id="fecha">
            </select>
        </div>

        <div class="form-group honeypot">
            <label for="apellidoBot">No llenar este campo:</label>
            <input type="text" id="apellidoBot" name="apellidoBot">
        </div>

        <button id="btnReservar">Reservar</button>
    </div>
    
    <script>
        // *** 1. CONFIGURACI√ìN CRUCIAL ***
        // üí° 1. REVISA TU URL DE APPS SCRIPT. DEBE SER LA √öLTIMA DE TU DEPLOYMENT ACTIVO
        const EXEC_URL = 'https://script.google.com/macros/s/AKfycbznmn09RZQb6o6-fh-VclrrE3Q2uRbxi-Nb3boBJN4qkAh8KZN9bH_sknGV30QmMubm/exec'; // ¬°REEMPLAZA ESTA URL!

        // Filtro de la obra
        const OBRA_FILTRO_NOMBRE = 'La Jirafa'; 

        // üí° 2. REVISA TU N√öMERO DE GESTOR
        const MANAGER_WHATSAPP_NUMBER = '5493492594940'; 

        let timerTimeout; 
        let todosLosCupos = {}; 

        // -------------------------------------------------------------------------
        // VALIDACI√ìN ESTRICTA DE WHATSAPP (Solo n√∫meros)
        // -------------------------------------------------------------------------
        function isNumberKey(evt) {
            const charCode = (evt.which) ? evt.which : event.keyCode;
            
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }


        /* Funci√≥n para mostrar mensajes de estado */
        function mostrarMensaje(texto, tipo = 'error') {
            const messageDiv = document.getElementById('message');
            
            if (!texto) {
                messageDiv.style.display = 'none';
                return;
            }

            messageDiv.textContent = texto;
            messageDiv.style.display = 'block';
            messageDiv.className = 'message'; 

            if (tipo === 'exito') {
                messageDiv.style.backgroundColor = '#d4edda'; 
                messageDiv.style.color = '#155724'; 
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 8000); 
            } else if (tipo === 'error') {
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.fontWeight = 'bold';
                messageDiv.style.textTransform = 'uppercase';
            }
        }

        /* CARGAR NOMBRE DE OBRA */
        async function cargarNombreObra() {
            const tituloObra = document.getElementById('tituloObra');
            
            try {
                // Obtenemos solo el nombre
                const url = EXEC_URL + '?accion=obtenerNombre&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE);
                const response = await fetch(url); 
                
                if (!response.ok) { 
                    throw new Error(`Error HTTP: ${response.status}`); 
                }
                
                const data = await response.json();
                
                if (data.status === 'OK' && data.nombre) {
                    const nuevoNombre = 'Reserva Entradas - ' + data.nombre;
                    document.title = nuevoNombre;
                    tituloObra.textContent = nuevoNombre;
                } else {
                    document.title = 'Reserva de Entradas';
                    tituloObra.textContent = 'Reserva de Entradas';
                }
            } catch(err) {
                console.error('Error FATAL al cargar nombre de obra:', err);
            }
        }

        
        /* TEMPORIZADOR (Columna 3) */
        function startTimer() {
            let duration = 0.25 * 60; // 15 segundos (C√°mbialo a 5 * 60 para 5 minutos de producci√≥n)
            const timerDiv = document.getElementById('timerDiv');
            // CLAVE 1: Obtener la referencia al bot√≥n
            const btn = document.getElementById('btnReservar'); 
            
            // CLAVE 2: Asegurar que el bot√≥n est√© activo al iniciar la p√°gina/contador
            if (btn) {
                btn.disabled = false;
                // Tambi√©n quitamos la clase 'loading' si qued√≥ de la reserva anterior
                btn.classList.remove('loading');
            }

            function updateTimer() {
                const minutes = parseInt(duration / 60, 10);
                const seconds = parseInt(duration % 60, 10);

                const displayMinutes = minutes < 10 ? "0" + minutes : minutes;
                const displaySeconds = seconds < 10 ? "0" + seconds : seconds;

                timerDiv.textContent = "‚è±Ô∏è " + displayMinutes + ":" + displaySeconds; 

                if (--duration < 0) {
                    clearInterval(timerTimeout); 
                    
                    // CLAVE 3: Usar la variable 'btn' para deshabilitar si existe
                    if (btn) {
                        btn.disabled = true; 
                    }
                    
                    timerDiv.textContent = "‚è±Ô∏è 00:00";
                    mostrarMensaje('‚è∞ Tiempo agotado. Debes actualizar la p√°gina para iniciar una nueva reserva.', 'error'); 
                }
            }
            
            if (timerTimeout) clearInterval(timerTimeout); 
            timerTimeout = setInterval(updateTimer, 1000);
        }
        
        /* CARGAR OPCIONES DEL EVENTO */
        async function cargarOpcionesEventos(opciones) {
            const select = document.getElementById('fecha');
            select.innerHTML = '';
            const cupoDiv = document.getElementById('cupoDiv');

            if (opciones.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = "No hay eventos disponibles";
                select.appendChild(opt);
                cupoDiv.textContent = 'No hay eventos configurados.';
                return;
            }

            opciones.forEach(opcion => {
                const opt = document.createElement('option');
                opt.value = opcion.id;
                opt.textContent = opcion.texto; 
                select.appendChild(opt);
            });

            // CLAVE: 1. Cargamos el cupo de TODOS los eventos primero
            await actualizarCupo(); 
            
            // CLAVE: 2. Forzamos la actualizaci√≥n de cupo y precio para el PRIMER evento seleccionado.
            mostrarCupoSeleccionado();
        }


        /* ACTUALIZAR CUPO (Llamada al servidor) */
        async function actualizarCupo() {
            const cupoDiv = document.getElementById('cupoDiv');
            
            try {
                const response = await fetch(EXEC_URL + '?accion=consultarCupo'); 
                const data = await response.json();
                
                if (data.status === 'OK' && data.cupos) {
                    todosLosCupos = data.cupos; 
                } else {
                    cupoDiv.textContent = 'Error al verificar cupo.';
                }
            } catch(err) {
                console.error('Error al consultar cupo:', err);
                cupoDiv.textContent = 'Error de conexi√≥n.';
            }
        }


       /* MOSTRAR CUPO Y PRECIO SELECCIONADO (Columna 2 y 1) */
async function mostrarCupoSeleccionado() { 
    const selectFecha = document.getElementById('fecha');
    const idSeleccionado = selectFecha.value;
    const cupoDiv = document.getElementById('cupoDiv');
    const precioDiv = document.getElementById('precioUnitario'); 
    const btnReservar = document.getElementById('btnReservar'); 
    const timerDiv = document.getElementById('timerDiv'); // <-- Nuevo: Obtenemos el div del temporizador
    
    
    // üõë CLAVE 1: VERIFICAR SI EL TIEMPO EST√Å AGOTADO
    if (timerDiv.textContent.includes('00:00')) {
        // Si el tiempo se agot√≥, el bot√≥n DEBE permanecer deshabilitado.
        if (btnReservar) btnReservar.disabled = true;
        
        // Tambi√©n mostramos el mensaje de tiempo agotado si ya no est√° visible
        // para recordar al usuario por qu√© no puede reservar.
        if (document.getElementById('message').style.display === 'none') {
             mostrarMensaje('‚è∞ Tiempo agotado. Debes actualizar la p√°gina para iniciar una nueva reserva.', 'error');
        }
        return; 
    }
    
    // Si el c√≥digo llega aqu√≠, el temporizador est√° ACTIVO.
    
    if (!idSeleccionado || idSeleccionado === "") {
         cupoDiv.textContent = 'Selecciona una funci√≥n.';
         precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
         // Deshabilitamos si no hay selecci√≥n
         if (btnReservar) btnReservar.disabled = true; 
         return;
    }


    // 1. Actualizar Cupo (lo hacemos con los datos que ya tenemos en 'todosLosCupos')
    if (todosLosCupos.hasOwnProperty(idSeleccionado)) {
        const cupoRestante = todosLosCupos[idSeleccionado];

        if (cupoRestante === 0) {
            cupoDiv.textContent = 'üéüÔ∏è AGOTADO';
            cupoDiv.classList.add('agotado-rojo');
            // Deshabilitar el bot√≥n al estar agotado
            if (btnReservar) btnReservar.disabled = true; 
        } else {
            // Habilitar el bot√≥n si hay cupo Y el tiempo NO se agot√≥ (ya verificado arriba)
            cupoDiv.textContent = `üéüÔ∏è ${cupoRestante} disp.`;
            cupoDiv.classList.remove('agotado-rojo');
            if (btnReservar) btnReservar.disabled = false; 
        }

        // ... El resto del c√≥digo de Opciones del select y Precio es el mismo ...
        
        // Opciones del select: (Actualizaci√≥n de agotado)
        const opciones = selectFecha.options;
        for (let opt of opciones) {
            if(todosLosCupos.hasOwnProperty(opt.value)) {
                 const cupo = todosLosCupos[opt.value];
                 let textoLimpio = opt.textContent.replace(' (Agotado)', '').trim();

                 if (cupo === 0) {
                    opt.textContent = textoLimpio + " (Agotado)";
                    opt.style.color = "#b5b5b5"; 
                 } else {
                    opt.textContent = textoLimpio; 
                    opt.style.color = "black";
                 }
            }
        }
        
        // 2. Actualizar Precio Espec√≠fico del Evento (Llamada al servidor)
        try {
            precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
            const url = EXEC_URL + '?accion=obtenerPrecio&idEvento=' + encodeURIComponent(idSeleccionado);
            const response = await fetch(url);
            const data = await response.json();

            if (data.status === 'OK' && data.precio) {
                precioDiv.innerHTML = `
                    <span style="font-size:0.9em; display:block;">VALOR</span>
                    <span class="precio-monto">$${data.precio}</span>
                `;
            } else {
                precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">N/A</span>';
            }
        } catch (error) {
            console.error('Error al actualizar precio:', error);
            precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">Error</span>';
        }
        
    } else {
        cupoDiv.textContent = 'Selecciona una funci√≥n.';
        precioDiv.innerHTML = '<span style="font-size:0.9em; display:block;">VALOR</span> <span class="precio-monto">...</span>';
        if (btnReservar) btnReservar.disabled = true; 
    }
}


        /* BOTON RESERVA - C√ìDIGO CORREGIDO */
        document.getElementById('btnReservar').onclick = async function() {
            mostrarMensaje(''); 

            const btn = this; // Guardamos la referencia al bot√≥n

            const nombre = document.getElementById('nombre').value.trim();
            const telefonoCliente = document.getElementById('telefono').value.trim().replace(/\D/g,''); 
            const cantidad = parseInt(document.getElementById('cantidad').value);
            const fecha = document.getElementById('fecha').value; 

            if (!nombre || !telefonoCliente || !cantidad || !fecha) {
                mostrarMensaje('üí° Completa todos los campos.', 'error');
                return;
            }

            // Comprobaci√≥n de que el bot√≥n no est√© ya deshabilitado (por el temporizador o cupo agotado)
            if (btn.disabled) {
                 mostrarMensaje('‚è∞ Tiempo de reserva agotado o evento sin cupo. Actualiza la p√°gina para comenzar de nuevo.', 'error');
                 return; 
            }


            // VALIDACI√ìN HONEYPOT (ANTI-SPAM)
            const apellidoBot = document.getElementById('apellidoBot').value.trim();
            if (apellidoBot.length > 0) {
                mostrarMensaje('‚ùå Error de validaci√≥n de formulario.', 'error');
                return; 
            }

            // Verifica que haya cupo (doble chequeo)
            const cupoActual = todosLosCupos[fecha] || 0;
            if (cantidad > cupoActual) {
                 mostrarMensaje(`Solo quedan ${cupoActual} entradas. Ajusta la cantidad.`, 'error');
                 return;
            }

            const formData = new URLSearchParams();
            formData.append('accion', 'reservar');
            formData.append('nombre', nombre);
            formData.append('telefono', telefonoCliente);
            formData.append('cantidad', cantidad);
            formData.append('fecha', fecha); 

            // Desactivamos y mostramos carga ANTES de la llamada
            btn.disabled = true;
            btn.classList.add('loading');
            clearInterval(timerTimeout); // Detenemos el contador


            try {
                const response = await fetch(EXEC_URL, { method: 'POST', body: formData }); 
                const data = await response.json();

                if (data.status === 'OK') {
                    mostrarMensaje(`‚úÖ ¬°RESERVA EXITOSA! ID: ${data.id}. Total: $${data.montoTotal}. Redirigiendo a WhatsApp...`, 'exito');
                    
                    const mensajeWhatsApp = [
                        `¬°Hola! Mi reserva es la ID: *${data.id}*.`,
                        `Confirmo la reserva de *${cantidad}* entradas.`,
                        `Mi tel√©fono (Cliente) es: *${telefonoCliente}*`, 
                        `El monto total es de *$${data.montoTotal}*.`,
                        ``,
                        `‚≠ê *LINK DE PAGO MERCADO PAGO:*`,
                        `${data.linkPago}`, 
                        ``,
                        `*IMPORTANTE:* Si el pago no se realiza en 5 minutos, la reserva puede cancelarse.`
                    ].join('\n'); 

                    const mensajeURL = encodeURIComponent(mensajeWhatsApp);
                    
                    window.open(`https://wa.me/${MANAGER_WHATSAPP_NUMBER}?text=${mensajeURL}`, '_blank');
                    
                    // Actualiza cupo despu√©s de reservar
                    actualizarCupo().then(() => mostrarCupoSeleccionado());
                    
                    // Si es exitoso, dejamos el bot√≥n deshabilitado y quitamos la clase loading
                    btn.disabled = true; 
                    btn.classList.remove('loading');
                    
                } else {
                    // Si hay un error del servidor, reactivamos el bot√≥n y el temporizador
                    mostrarMensaje('‚ùå ' + data.message, 'error');
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    startTimer(); 
                }
                
            } catch(err) {
                // Si hay un error de conexi√≥n, reactivamos el bot√≥n y el temporizador
                mostrarMensaje('‚ùå Error de conexi√≥n o red: ' + err.message, 'error');
                btn.disabled = false;
                btn.classList.remove('loading');
                startTimer(); 
            }
        };


        document.getElementById('fecha').addEventListener('change', mostrarCupoSeleccionado);


        // *** 4. INICIAR LAS FUNCIONES AL CARGAR ***
        cargarNombreObra(); 
        startTimer(); 
        // Primero cargamos las opciones de fecha/evento
        fetch(EXEC_URL + '?accion=obtenerOpciones&obra=' + encodeURIComponent(OBRA_FILTRO_NOMBRE))
            .then(response => response.json())
            .then(data => cargarOpcionesEventos(data))
            .catch(err => {
                console.error('Error FATAL al cargar eventos (EXEC_URL incorrecta?):', err);
                document.getElementById('cupoDiv').textContent = 'Error cr√≠tico al cargar eventos. Verifique la URL de Apps Script.';
            });
    </script>
</body>
</html>


